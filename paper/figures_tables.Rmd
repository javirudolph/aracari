---
title: "Figures and Tables"
subtitle: ' '
output:
  html_document:
    toc: yes
  word_document:
    toc: yes
bibliography: ../paper/mybibfile.bib
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo = FALSE)
```

```{r libraries}
library(ggplot2)
library(aracari)
library(cowplot)
library(dplyr)

```

```{r}
# Simulate the data for one run

set.seed(5)

data(ptpl)

# Panel 2: Table with gut retention times and the gamma distribution used for it
n <- 10000
grt_dens <- data.frame(seq = 1:n, dat = (rgamma(n, shape = 4, scale = 5) + 8))
grt_data <- data.frame(time = round(sample(grt_dens$dat, 5)), seq = 1:5)
tt <- max(grt_data$time)
ggplot(grt_dens, aes(x = dat)) +
  geom_density() + 
  geom_point(data = grt_data, aes(x = time, y = 0), color = "red") +
  #geom_point(aes(x = tt, y = 0), color = "red") +
  theme_bw() + labs(x = "Time in minutes", y = "Density") -> fig_GRT


# Panel 3: Exponential distribution used for animal movement lengths
rate <- 1/mean(ptpl$mpm)
md_dens <- data.frame(seq = 1:n, dat = rexp(n, rate = rate))
md_hist <- data.frame(md = round(sample(md_dens$dat, tt)))

ggplot(md_dens, aes(x = dat)) +
  geom_density() + 
  geom_point(data = md_hist, aes(x = md, y = 0)) +
  theme_bw() + labs(x = "Distance in meters", y = "Density") -> fig_MD


ggplot(md_hist, aes(x = md)) +
  geom_histogram() +
  theme_bw() + labs(x = "Distance in meters", y = "Count") -> fig_MD_hist

# Panel 4: Animal trajectory and locations of the seeds at the time the seeds are dropped
set.seed(5)
distance <- md_hist$md
angle <- runif(tt, min = 0, max = 360)
distx <- distance*cos(angle)
xloc <- c(0, cumsum(distx))
disty <- distance*sin(angle)
yloc <- c(0, cumsum(disty))
animalTraj <- data.frame(time = 0:tt, xloc = xloc, yloc = yloc)
seed_loc <- merge(animalTraj, grt_data, by = "time")
mean_seed_loc <- data.frame(x = mean(seed_loc$xloc), y = mean(seed_loc$yloc))

ggplot() +
  geom_path(data = animalTraj, aes(x = xloc, y = yloc), size = 1, color = "darkgrey") +
  geom_point(data = animalTraj, aes(x = xloc, y = yloc), color = "black", size = 1) +
  geom_point(data = seed_loc, aes(x = xloc, y = yloc), color = "red", size = 3) +
  geom_point(aes(x = 0, y = 0), color = "black", size = 5)+
  geom_vline(aes(xintercept=0), linetype = "dotted") + geom_hline(aes(yintercept = 0), linetype = "dotted") +
  labs(x = "x", y = "y") +
  coord_fixed() +
  theme_bw() -> fig_traj

ggplot() +
  geom_point(data = seed_loc, aes(x = xloc, y = yloc), color = "red", size = 3) +
  geom_point(aes(x = 0, y = 0), color = "black", size = 5)+
  geom_vline(aes(xintercept=0), linetype = "dotted") + geom_hline(aes(yintercept = 0), linetype = "dotted") +
  geom_segment(aes(x = seed_loc$xloc, xend = 0, y = seed_loc$yloc, yend = 0), linetype = "dashed", color = "red") +
  labs(x = "x", y = "y") +
  coord_fixed() +
  theme_bw() -> fig_disp

ggplot() +
  geom_point(data = seed_loc, aes(x = xloc, y = yloc), color = "red", size = 3) +
  geom_point(aes(x = 0, y = 0), color = "black", size = 5)+
  geom_vline(aes(xintercept=0), linetype = "dotted") + geom_hline(aes(yintercept = 0), linetype = "dotted") +
  #geom_segment(aes(x = seed_loc$xloc, xend = 0, y = seed_loc$yloc, yend = 0), linetype = "dashed", color = "red") +
  geom_point(data = mean_seed_loc, aes(x = x, y = y), color = "blue", size = 4) +
  geom_segment(aes(x = seed_loc$xloc, xend = mean_seed_loc$x, y = seed_loc$yloc, yend = mean_seed_loc$y), linetype = "dashed", color = "blue") +
  labs(x = "x", y = "y") +
  coord_fixed() +
  theme_bw() -> fig_agg

```

## Figure 1. 
Density distributions from which we sample gut retention time (GRT) and movement distance (MD). 

```{r fig.width=2.5, fig.height=4}
plot_grid(fig_GRT, fig_MD, align = "v", nrow = 2, labels = "auto", label_size = 10)
```

## Figure 2.
Simulation example where animal movement determines location for seeds dropped. Calculations for seed dispersal distance from the parent tree and seed distance to the mean seed location as a measure of aggregation. 

```{r fig.height=2, fig.width=6}
plot_grid(fig_traj, fig_disp, fig_agg, ncol = 3, align = "h", labels = "auto", label_size = 8)
```

## Figure 3.
Variation in Weibull distributions determined by the value of the shape parameter. The scale parameter is defined as $b=1$, and the shape parameters are defined as follows: solid line $a=\nu=1$ shows an exponential decay tail, dashed line $a=\nu=0.2$ shows a thin tail, and $a=\nu=2$ describes a fat tail with the dotted line.

```{r fig.width=3, fig.height=2.5}
# shape
exptail <- 1
thintail <- 0.2
fattail <- 2

#scale
b <- 1
kappaexp <- b^-exptail
kappathin <- b^-thintail
kappafat <- b^-fattail

ggplot(data = data.frame(x = c(0.1, 4)), aes(x)) +
  stat_function(fun = dweibull, n = 100, args = list(scale = b, shape = thintail),
                color = "black", linetype = "dashed", size = 0.8) +
  stat_function(fun = dweibull, n = 100, args = list(scale = b, shape = exptail), 
                color = "black", linetype = "dotted", size = 0.8) +
  stat_function(fun = dweibull, n = 100, args = list(scale = b, shape = fattail),
                color = "black", linetype = "solid", size = 0.8) +
  ylab("") + xlab("") +
  theme_bw()
  
```

```{r}
load("paper/dispersal_kernels.RData")

```

### Figure x.
Distribution of dispersal distances produced by each of the simulation models considered.
```{r fig.width=3}
bind_rows(null_dispersal %>% mutate(model = "Null"), 
          indiv_dispersal %>% mutate(model = "Individual"),
          fam_dispersal %>% mutate(model = "Family")) %>% 
  mutate(model = factor(model, levels = c("Null", "Individual", "Family"))) -> dispersal_data
  
dispersal_data %>% 
  ggplot(., aes(x = dispersal, group = model)) +
  facet_wrap(~model, nrow = 3) +
  geom_histogram(aes(y = ..density..), binwidth = 50) +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white")) +
  labs(y = "Density", x = "Seed dispersal (m)")
  
```

```{r eval = FALSE}
null_prms <- null_weibull$estimate
null_sd <- null_weibull$sd
null_dispersal %>% 
  ggplot(., aes(x = dispersal)) +
  geom_histogram(aes(y = ..density..), color = "grey", fill = "grey") +
  stat_function(fun = dweibull, n = 100, args = list(shape = null_prms[1], scale = null_prms[2]),
                linetype = "solid", size = 1, color = "black") +
  theme_bw() +
  labs(y = "Density", x = "Seed dispersal (m)") +
  lims(y = c(0, 0.004), x = c(0, 1500)) -> null_kernel

indiv_prms <- indiv_weibull$estimate
indiv_sd <- indiv_weibull$sd
indiv_dispersal %>% 
  ggplot(., aes(x = dispersal)) +
  geom_histogram(aes(y = ..density..), color = "grey", fill = "grey") +
  stat_function(fun = dweibull, n = 100, args = list(shape = indiv_prms[1], scale = indiv_prms[2]),
                linetype = "solid", size = 1, color = "black") +
  theme_bw() +
  labs(y = "Density", x = "Seed dispersal (m)") +
  lims(y = c(0, 0.004), x = c(0, 1500)) -> indiv_kernel

fam_prms <- fam_weibull$estimate
fam_sd <- fam_weibull$sd
fam_dispersal %>% 
  ggplot(., aes(x = dispersal)) +
  geom_histogram(aes(y = ..density..), color = "grey", fill = "grey") +
  stat_function(fun = dweibull, n = 100, args = list(shape = fam_prms[1], scale = fam_prms[2]),
                linetype = "solid", size = 1, color = "black") +
  theme_bw() +
  labs(y = "Density", x = "Seed dispersal (m)") +
  lims(y = c(0, 0.004), x = c(0, 1500)) -> fam_kernel

plot_grid(null_kernel, indiv_kernel, fam_kernel, ncol = 1)
```

## Figure 4. 
Box plots to show the distribution of mean seed dispersal distance and seed dispersion per simulation run. In this case, we are looking at the data per simulation run, since we calculate seed dispersion in relation to the mean seed location, and this is done for each simulation run with five seeds each. Here, we consider mean seed dispersal as the distance from the origin to the mean seed location for each simulation run.

```{r}

null_dispersion %>% 
  mutate(model = "Null") %>% 
  bind_rows(indiv_dispersion %>% 
              mutate(model = "Individual")) %>% 
  bind_rows(fam_dispersion %>% 
              mutate(model = "Family")) %>% 
  mutate(model = factor(model, levels = c("Null", "Individual", "Family"))) -> all_disp_data
  
all_disp_data %>% 
  ggplot(., aes(y = mean_xy_dispersal, x = model)) +
  geom_boxplot() +
  theme_bw() +
  labs(y = "Mean dispersal (m)") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank()) -> a


all_disp_data %>% 
  ggplot(., aes(y = seed_dispersion, x = model)) +
  geom_boxplot() +
  theme_bw() +
  labs(y = "Seed dispersion (m)") +
  theme(axis.title.x = element_blank()) -> b


plot_grid(a,b, nrow = 2)

# Edit redundant labels
# Fix names for axes

```

```{r fig.width=6, fig.height=3}
plot_grid(a,b, ncol = 2)
```

# Table 1.

```{r}
dispersal_kernel_table <- data.frame(
  Model = c("Null", "Individual", "Family"),
  Mean_dispersal = c(signif(mean(null_dispersal$dispersal), 4),
                     signif(mean(indiv_dispersal$dispersal), 4),
                     signif(mean(fam_dispersal$dispersal),4)),
  Seed_dispersion = c(signif(mean(null_dispersion$seed_dispersion), 4),
                      signif(mean(indiv_dispersion$seed_dispersion), 4),
                      signif(mean(fam_dispersion$seed_dispersion),4)),
  Max_dispersal = c(signif(max(null_ldd$global_max), 4),
                           signif(max(indiv_ldd$global_max), 4),
                           signif(max(fam_ldd$global_max), 4)),
  # Max_dispersal = c(paste0(signif(null_ldd$max_mean, 3), " (", signif(null_ldd$max_sd, 1), ")"),
  #                   paste0(signif(indiv_ldd$max_mean, 3), " (", signif(indiv_ldd$max_sd, 1), ")"),
  #                   paste0(signif(fam_ldd$max_mean, 3), " (", signif(fam_ldd$max_sd, 1), ")")),
  LDD = c(paste0(signif(null_ldd$prcnt_ldd, 3), " (", signif(null_ldd$sd_ldd, 1), ")", "%"),
          paste0(signif(indiv_ldd$prcnt_ldd, 3), " (", signif(indiv_ldd$sd_ldd, 1), ")", "%"),
          paste0(signif(fam_ldd$prcnt_ldd, 3), " (", signif(fam_ldd$sd_ldd, 1), ")", "%")),
  Weibull_Shape = c(paste0(signif(null_weibull$estimate[1], 4), " (", signif(null_weibull$sd[1], 2), ")"),
                    paste0(signif(indiv_weibull$estimate[1], 4), " (", signif(indiv_weibull$sd[1], 2), ")"),
                    paste0(signif(fam_weibull$estimate[1], 4), " (", signif(fam_weibull$sd[1], 2), ")")),
  Weibull_Scale = c(paste0(signif(null_weibull$estimate[2], 4), " (", signif(null_weibull$sd[2], 2), ")"),
                     paste0(signif(indiv_weibull$estimate[2], 4), " (", signif(indiv_weibull$sd[2], 2), ")"),
                     paste0(signif(fam_weibull$estimate[2], 4), " (", signif(fam_weibull$sd[2], 2), ")"))

)

```

