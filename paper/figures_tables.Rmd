---
title: "Figures and Tables"
subtitle: ' '
output:
  html_document:
    toc: yes
  word_document:
    toc: yes
bibliography: ../paper/mybibfile.bib
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo = FALSE)
```

```{r libraries}
library(ggplot2)
library(aracari)
library(cowplot)
library(dplyr)
library(extRemes)

```

```{r}
load("paper/fevd.RData")
```

```{r}
# Simulate the data for one run

set.seed(5)

data(ptpl)

# Panel 2: Table with gut retention times and the gamma distribution used for it
n <- 10000
grt_dens <- data.frame(seq = 1:n, dat = (rgamma(n, shape = 4, scale = 5) + 8))
grt_data <- data.frame(time = round(sample(grt_dens$dat, 5)), seq = 1:5)
tt <- max(grt_data$time)
ggplot(grt_dens, aes(x = dat)) +
  geom_density() + 
  geom_point(data = grt_data, aes(x = time, y = 0), color = "red") +
  #geom_point(aes(x = tt, y = 0), color = "red") +
  theme_bw() + labs(x = "Time in minutes", y = "Density") -> fig_GRT


# Panel 3: Exponential distribution used for animal movement lengths
rate <- 1/mean(ptpl$mpm)
md_dens <- data.frame(seq = 1:n, dat = rexp(n, rate = rate))
md_hist <- data.frame(md = round(sample(md_dens$dat, tt)))

ggplot(md_dens, aes(x = dat)) +
  geom_density() + 
  geom_point(data = md_hist, aes(x = md, y = 0)) +
  theme_bw() + labs(x = "Distance in meters", y = "Density") -> fig_MD


ggplot(md_hist, aes(x = md)) +
  geom_histogram() +
  theme_bw() + labs(x = "Distance in meters", y = "Count") -> fig_MD_hist

# Panel 4: Animal trajectory and locations of the seeds at the time the seeds are dropped
set.seed(5)
distance <- md_hist$md
angle <- runif(tt, min = 0, max = 360)
distx <- distance*cos(angle)
xloc <- c(0, cumsum(distx))
disty <- distance*sin(angle)
yloc <- c(0, cumsum(disty))
animalTraj <- data.frame(time = 0:tt, xloc = xloc, yloc = yloc)
seed_loc <- merge(animalTraj, grt_data, by = "time")
mean_seed_loc <- data.frame(x = mean(seed_loc$xloc), y = mean(seed_loc$yloc))

ggplot() +
  geom_path(data = animalTraj, aes(x = xloc, y = yloc), size = 1, color = "darkgrey") +
  geom_point(data = animalTraj, aes(x = xloc, y = yloc), color = "black", size = 1) +
  geom_point(data = seed_loc, aes(x = xloc, y = yloc), color = "red", size = 3) +
  geom_point(aes(x = 0, y = 0), color = "black", size = 5)+
  geom_vline(aes(xintercept=0), linetype = "dotted") + geom_hline(aes(yintercept = 0), linetype = "dotted") +
  labs(x = "x", y = "y") +
  coord_fixed() +
  theme_bw() -> fig_traj

ggplot() +
  geom_point(data = seed_loc, aes(x = xloc, y = yloc), color = "red", size = 3) +
  geom_point(aes(x = 0, y = 0), color = "black", size = 5)+
  geom_vline(aes(xintercept=0), linetype = "dotted") + geom_hline(aes(yintercept = 0), linetype = "dotted") +
  geom_segment(aes(x = seed_loc$xloc, xend = 0, y = seed_loc$yloc, yend = 0), linetype = "dashed", color = "red") +
  labs(x = "x", y = "y") +
  coord_fixed() +
  theme_bw() -> fig_disp

ggplot() +
  geom_point(data = seed_loc, aes(x = xloc, y = yloc), color = "red", size = 3) +
  geom_point(aes(x = 0, y = 0), color = "black", size = 5)+
  geom_vline(aes(xintercept=0), linetype = "dotted") + geom_hline(aes(yintercept = 0), linetype = "dotted") +
  #geom_segment(aes(x = seed_loc$xloc, xend = 0, y = seed_loc$yloc, yend = 0), linetype = "dashed", color = "red") +
  geom_point(data = mean_seed_loc, aes(x = x, y = y), color = "blue", size = 4) +
  geom_segment(aes(x = seed_loc$xloc, xend = mean_seed_loc$x, y = seed_loc$yloc, yend = mean_seed_loc$y),
               linetype = "dashed", color = "blue") +
  geom_segment(aes(x = 0, xend = mean_seed_loc$x, y = 0, yend = mean_seed_loc$y),
               linetype = "solid", color = "black") +
  labs(x = "x", y = "y") +
  coord_fixed() +
  theme_bw() -> fig_agg

```

#### Figure 1. 
Density distributions from which we sample **A.** gut retention time (GRT) and **B.** movement distance (MD). Red dots represent an example for one simulation run, where we sample five gut retention times. The maximum GRT for that simulation run determines the number of movement distances sampled in that simulation run, represented in the figure by the black dots.

```{r fig.width=2.5, fig.height=4}
plot_grid(fig_GRT, fig_MD, align = "v", nrow = 2, labels = "AUTO", label_size = 10)
```

#### Figure 2.
Example of one simulation run and variables measured for each run. **A.** Shows the animal trajectory followed after starting at the origin (big circle at location 0,0). The animal moves every minute following the movement distances (MD) sampled from the distribution as show in example of Figure 1. Every small black dot represents the animal's location at every minute interval. Seeds get dropped every time the simulation reaches one of the sampled gut retention times (GRT), at the animal's location in that time (red dots). **B.** Seed dispersal calculations as euclidean distances from the parent plant located at the origin (black circle at 0,0) to each of the five seeds for the simulation run (red dots). **C.** Calculation of seed dispersion measures and average seed dispersal. The average seed location for the simulation run is shown by the blue circle. The distance from each seed to the average location is used to calculate seed dispersion as a measure of seed aggregation, dashed blue lines. Average seed dispersal is calculated as the distance from the parent plant to the average seed location, shown as the black line connecting the black circle to the blue dot.

```{r fig.height=2, fig.width=6}
plot_grid(fig_traj, fig_disp, fig_agg, ncol = 3, align = "h", labels = "AUTO", label_size = 8)
```

#### Figure 3.
Variation in Weibull and Generalized Pareto distributions determined by the value of the shape parameter. **A.** In the case of the Weibull distribution, the scale parameter is defined as $b=1$, and the shape parameters are defined as follows: solid line $a=\nu=0.4$ shows a heavy tail, the dashed line $a=\nu=2$ shows a thin tail, and $a=\nu=1$ describes an exponential tail with the dotted line. This follows the assumption that a shape parameter $\nu<1$ describes a fat tail, $\nu>1$ a thin tail, and $\nu=1$ a tail following an exponential distribution. **B.** In the case of the Generalized Pareto distribution, a shape parameter $\xi=0$ describes an exponential distribution function, shape $\xi>0$ describes a heavy tail, and $\xi<0$ a tail with Beta distribution function, bounded at an upper value as a function of the threshold and scale parameters. In the second panel, the scale parameter is set to $\sigma = 1$ the solid line $\xi = 1$ shows a heavy tail, dashed line $\xi=-0.6$ shows a Beta tail, and $\xi = 0$ describes an exponential decay with the dotted line.

```{r fig.width=6, fig.height=2.5}
# shape
exptail <- 1
thintail <- 2
fattail <- 0.4

#scale
b <- 1
kappaexp <- b^-exptail
kappathin <- b^-thintail
kappafat <- b^-fattail

ggplot(data = data.frame(x = c(0.1, 4)), aes(x)) +
  stat_function(fun = dweibull, n = 100, args = list(scale = b, shape = thintail),
                color = "black", linetype = "dashed", size = 0.8) +
  stat_function(fun = dweibull, n = 100, args = list(scale = b, shape = exptail), 
                color = "black", linetype = "dotted", size = 0.8) +
  stat_function(fun = dweibull, n = 100, args = list(scale = b, shape = fattail),
                color = "black", linetype = "solid", size = 0.8) +
  ylab("") + xlab("") +
  lims(y = c(0, 1)) +
  theme_bw() -> weib_dens


# The shape parameter determines the behavior of the tail of the Generalized Pareto
# ?extRemes::devd
# shape = 0 gives rise to exponential disttribution function (thin tail)
# shape > 0 is a heavy tail
# shape < 0 is a tail following a Beta distribution function, a bounded upper tail at location-scale.u/shape

# shape
exptail <- 0
heavytail <- 1.2
betatail <- -0.6

# scale
gp_scale <- 1


ggplot(data = data.frame(x = c(0.1, 4)), aes(x)) +
  stat_function(fun = devd, n = 100, args = list(scale = gp_scale, shape = betatail, type = "GP"),
                color = "black", linetype = "dashed", size = 0.8) +
  stat_function(fun = devd, n = 100, args = list(scale = gp_scale, shape = exptail, type = "GP"), 
                color = "black", linetype = "dotted", size = 0.8) +
  stat_function(fun = devd, n = 100, args = list(scale = gp_scale, shape = heavytail, type = "GP"),
                color = "black", linetype = "solid", size = 0.8) +
  ylab("") + xlab("") +
  lims(y = c(0, 1)) +
  theme_bw() -> gp_dens


plot_grid(weib_dens, gp_dens, ncol = 2, labels = "AUTO", label_size = 8)




  
``` 


## Seed dispersal distances and aggregation
#### Figure 4. Seed dispersal distances and aggregation metrics for simulated seeds in the three models considering variation in animal movement rates. **A.** Density kernels for frugivore-generated seed dispersal distances for each seed simulated under the three models of variation in animal movement rates. Each individual line represents the dispersal kernel generated by each individual animal. The null model assumes the same movement rate for all animals, whereas individual and family models use a movement rate for each animal id, or family group. **B.** Box plot comparing the distances from the parent tree at the origin to the mean seed location in each simulation run among the three simulation models. **C.** Box plot comparing the seed aggregation metric, seed dispersion, for each simulation run between the three simulation models. *Is there more comparison I should mention here? Like, how the larger values are more abundant in the individual model?*

```{r fig.width=6}

# Dispersal data for each of the seeds
bind_rows(null_dispersal %>% mutate(model = "Null"), 
          indiv_dispersal %>% mutate(model = "Individual"),
          fam_dispersal %>% mutate(model = "Family")) %>% 
  mutate(model = factor(model, levels = c("Null", "Individual", "Family"))) -> dispersal_data
  
dispersal_data %>% 
  ggplot(., aes(x = dispersal, group = model)) +
  facet_wrap(~model, ncol = 3) +
  geom_histogram(aes(y = ..density..), binwidth = 50) +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white")) +
  labs(y = "Density", x = "Seed dispersal (m)") -> histograms

dispersal_data %>% 
  ggplot(., aes(x = dispersal, group = id)) +
  facet_wrap(~model, ncol = 3) +
  geom_density() +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white")) +
  labs(y = "Density", x = "Seed dispersal (m)") -> histograms_by_id

# These measures are by simulation run. So, they are average/mean seed dispersal and seed dispersion. Only one value per simulation run.  
null_dispersion %>% 
  mutate(model = "Null") %>% 
  bind_rows(indiv_dispersion %>% 
              mutate(model = "Individual")) %>% 
  bind_rows(fam_dispersion %>% 
              mutate(model = "Family")) %>% 
  mutate(model = factor(model, levels = c("Null", "Individual", "Family"))) -> all_disp_data
  
all_disp_data %>% 
  ggplot(., aes(y = mean_xy_dispersal, x = model)) +
  geom_boxplot() +
  theme_bw() +
  labs(y = "Average seed location (m)") +
  theme(axis.title.x = element_blank()) -> a


all_disp_data %>% 
  ggplot(., aes(y = seed_dispersion, x = model)) +
  geom_boxplot() +
  theme_bw() +
  labs(y = "Seed dispersion (m)") +
  theme(axis.title.x = element_blank()) -> b


boxplots <- plot_grid(a,b, ncol = 2, align = "h", labels = c("B", "C"))

plot_grid(histograms_by_id, boxplots, nrow=2, labels = c("A", ""))

# Edit redundant labels
# Fix names for axes

```

## Long distance dispersal

The mean dispersal in the boxplots is not the same as the dispersal distances before. This mean dispersal is the distance from the origin to the mean seed location in each simulation run. The mean seed location is used to calculate dispersion, as the average distance of each seed to the mean seed location, as shown in Figure 1.

```{r}
knitr::kable(dispersal_kernel_table %>% 
               rename(Long_distance = LDD))
```

## Weibull seed dispersal kernel 
```{r}
knitr::kable(weibull_table)
``` 

## Generalized Pareto tail distribution for seed dispersal


```{r}
knitr::kable(evd_table_500)
```


