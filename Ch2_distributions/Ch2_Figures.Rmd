---
title: "Distributions"
author: "Javiera Rudolph"
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
# knitr::opts_chunk$set(fig.width=12, fig.height=6)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r message=FALSE, warning=FALSE}
library(aracari)
library(dplyr)
library(tidyr)
library(ggplot2)
library(cowplot)
library(fitdistrplus)
library(stringr)
library(gt)

```


```{r include=FALSE}
set.seed(20211207)

# Data ----------------------------------------------------
# The script for this data is in the data-raw folder
load("data/ptpl.rda")

ptpl %>%
  filter(., mpm != 0) -> ptpl
```

# Figure 1  

```{r include=FALSE}
# Color palette ----------------------------------------
my.cols1 <- c("#23262f","#717492","#b3a82a","#c94f21","#980012",
              "#0d907a","#b9bec3","#31aec5", "#653625", "#2C5C5D",
              "#DEB41E", "#2D3335", "#E2BF80", "#87A986", "#59879A",
              "#9C1D29", "#24716B", "#4a92b0")
scales::show_col(my.cols1)

my.cols2 <- c("#23262f", "#0d907a", "#DEB41E", 
              "#9C1D29", "#c76620", "#4a92b0",
              "#669e46", "grey")
scales::show_col(my.cols2)

```


```{r}

ptpl %>%
  ggplot(., aes((x = mpm))) +
  #geom_line(aes(x = mpm, group = id, color = fam_g), stat = "density", alpha = 0.8) +
  geom_line(aes(x = mpm, group = id), color = "grey", 
            stat = "density", alpha = 0.8) +
  # geom_line(aes(x = mpm, group = fam_g), stat = "density", alpha = 0.4,
  #           color = "blue") +
  geom_line(stat = "density", color = "black", lwd = 1) +
  geom_vline(xintercept = 0, color = "grey") +
  geom_hline(yintercept = 0, color = "grey") +
  labs(y = "Density", x = "Velocity in m/min") +
  theme_classic() +
  scale_color_manual(values = my.cols2) +
  theme(legend.position = "none")
```


```{r eval=FALSE, Figure1, fig.height=6, fig.width=4}
# Figure 1 ---------------------------------------------
# Distribution of velocities at the different pooling levels

cols.fig1 <- c("#23262f","#717492","#b3a82a","#c94f21","#980012","#0d907a","#b9bec3")

ptpl %>%
  ggplot(., aes((x = mpm))) +
  #geom_line(aes(x = mpm, group = id), stat = "density", alpha = 0.4) +
  # geom_line(aes(x = mpm, group = fam_g), stat = "density", alpha = 0.4,
  #           color = "blue") +
  geom_line(stat = "density", color = "black") +
  geom_vline(xintercept = 0, color = "grey") +
  geom_hline(yintercept = 0, color = "grey") +
  labs(y = "Density", x = "Velocity in m/min") +
  theme_classic() +
  lims(y = c(0, 0.05)) -> cp_lines

ptpl %>%
  ggplot(., aes((x = mpm))) +
  geom_line(aes(x = mpm, group = id, color = fam_g), stat = "density") +
  # geom_line(aes(x = mpm, group = fam_g), stat = "density", alpha = 0.4,
  #           color = "blue") +
  #geom_line(stat = "density", color = "#1191d1", lwd = 1) +
  geom_vline(xintercept = 0, color = "grey") +
  geom_hline(yintercept = 0, color = "grey") +
  labs(y = "Density", x = "Velocity in m/min") +
  theme_classic() +
  scale_color_manual(values = cols.fig1) +
  theme(legend.position = "none") +
  lims(y = c(0, 0.05)) -> np_lines

ptpl %>%
  ggplot(., aes((x = mpm))) +
  #geom_line(aes(x = mpm, group = id), stat = "density", alpha = 0.4) +
  geom_line(aes(x = mpm, group = fam_g, color = fam_g),
            stat = "density") +
  #geom_line(stat = "density", color = "#1191d1", lwd = 1) +
  geom_vline(xintercept = 0, color = "grey") +
  geom_hline(yintercept = 0, color = "grey") +
  labs(y = "Density", x = "Velocity in m/min") +
  theme_classic() +
  scale_color_manual(values = cols.fig1) +
  theme(legend.position = "none") +
  lims(y = c(0, 0.05)) -> pp_lines

plot_grid(cp_lines, pp_lines, np_lines, nrow = 3)

```  


# Fits 

```{r}
load("Ch2_distributions/Ch2_fits.RData")
```


```{r}
reg_fits_info %>% 
  dplyr::select(., dist, dBIC, ID, model) %>% 
  distinct() %>% 
  filter(., dBIC == 0) -> bestmodel

#bestmodel
```


```{r eval=FALSE}
# Difference to the second best model

reg_fits_info %>% 
  dplyr::select(., dist, dBIC, ID, model) %>% 
  distinct() %>% 
  ggplot(., aes(x = ID, y = dBIC, color = dist)) +
  #facet_wrap(~model) +
  geom_point()

```


Calculate the BIC for the models:

```{r}
reg_fits_info %>% 
  dplyr::select(model, ID, dist, loglik, n, kpars) %>% 
  distinct() %>% 
  group_by(model, dist) %>% 
  summarise(BIC = log(sum(n))*sum(kpars) - 2 * sum(loglik)) -> A 

reg_fits_info %>% 
  filter(., model != "CP") %>% 
  dplyr::select(model, ID, dist, loglik, n, kpars, dBIC) %>% 
  distinct() %>% 
  filter(., dBIC == 0) %>% 
  group_by(model) %>% 
  summarise(BIC = log(sum(n))*sum(kpars) - 2 * sum(loglik)) %>% 
  transmute(model = model,
            dist = "Multi",
            BIC = BIC) -> B

rbind.data.frame(A, B) -> C
  

C %>%
  group_by(model) %>% 
  mutate(deltaBIC_withinmodels = signif(BIC - min(BIC), 3)) %>% 
  ungroup() %>% 
  mutate(deltaBIC_acrossmodels = signif(BIC - min(BIC), 3)) %>% 
  arrange(model) -> BIC_table
```

```{r}
cp.boot.fits %>% 
  dplyr::select(dist, bic, boot) %>% 
  distinct() %>% 
  transmute(dist = dist,
            BIC = bic,
            boot = boot,
            model = "CP") %>% 
  group_by(boot) %>% 
  mutate(., deltaBIC = signif(BIC - min(BIC), 3)) %>% 
  ungroup() -> cp.bic

pp.boot.fits %>% 
  dplyr::select(loglik, n, kpars, dist, fgroup, boot) %>% 
  distinct() %>% 
  group_by(boot, dist) %>% 
  summarise(BIC = log(sum(n))*sum(kpars) - 2 * sum(loglik)) %>% 
  transmute(dist = dist,
            BIC = BIC,
            boot = boot,
            model = "PP") %>% 
  bind_rows(., pp.boot.fits %>% 
  dplyr::select(loglik, n, kpars, dist, fgroup, boot, dBIC) %>% 
  distinct() %>% 
  filter(., dBIC == 0) %>% 
  group_by(boot) %>% 
  summarise(BIC = log(sum(n))*sum(kpars) - 2 * sum(loglik)) %>% 
  transmute(dist = "multi",
            BIC = BIC,
            boot = boot, 
            model = "PP")) %>% 
  group_by(boot) %>% 
  mutate(., deltaBIC = signif(BIC - min(BIC), 3)) %>% 
  ungroup() %>% 
  arrange(boot) -> pp.bic


  
np.boot.fits %>% 
  dplyr::select(loglik, n, kpars, dist, individual, boot) %>% 
  distinct() %>% 
  group_by(boot, dist) %>% 
  summarise(BIC = log(sum(n))*sum(kpars) - 2 * sum(loglik)) %>% 
  transmute(dist = dist,
            BIC = BIC,
            boot = boot,
            model = "NP") %>%   
  bind_rows(., np.boot.fits %>% 
  dplyr::select(loglik, n, kpars, dist, individual, boot, dBIC) %>% 
  distinct() %>% 
  filter(., dBIC == 0) %>% 
  group_by(boot) %>% 
  summarise(BIC = log(sum(n))*sum(kpars) - 2 * sum(loglik)) %>% 
  transmute(dist = "multi",
            BIC = BIC,
            boot = boot, 
            model = "NP")) %>% 
  group_by(boot) %>% 
  mutate(., deltaBIC = signif(BIC - min(BIC), 3)) %>% 
  ungroup() %>% 
  arrange(boot) -> np.bic



```
# Table 1 - 

For no bootstraps, just what are the BIC values we select. 


```{r}

BIC_table %>% 
  mutate(dist = ifelse(dist == "lnorm", "lognormal", dist),
         dist = str_to_title(dist)) %>% 
  mutate(model = factor(model, levels = c("CP", "PP", "NP"))) %>% 
  arrange(., model) -> BIC_table
# BIC_table

```

```{r}

#library(gt)

gt_tbl <- gt(BIC_table[, 2:5], rowname_col = "dist")


gt_tbl %>% 
  tab_header(
    title = md("**Model comparisons across levels**")
  ) %>% 
  tab_stubhead(label = "Model") %>% 
  tab_row_group(
    group = "NP",
    rows = 8:11
  ) %>% 
  tab_row_group(
    group = "PP",
    rows = 4:7
  ) %>% 
  tab_row_group(
    group = "CP", 
    rows = 1:3
  ) %>% 
  tab_spanner(
    label = md("**BIC**"),
    columns = vars(BIC, deltaBIC_withinmodels, deltaBIC_acrossmodels)
  ) %>% 
  cols_label(
    deltaBIC_withinmodels = html("&Delta; BIC<sub>within</sub>"),
    deltaBIC_acrossmodels = html("&Delta; BIC<sub>across</sub>"),
  ) 

# -> gt_table_bic
#   
# gtsave(gt_table_bic, "Ch2_distributions/aic_bic_table.png") 
```


```{r eval = FALSE}
knitr::include_graphics("Ch2_distributions/aic_bic_table.png")
```




# Figure 2 - 


```{r fig.width=12, fig.height=6}

cols.fig2 <- c("#b9bec3", 
               "#0d907a", "#DEB41E", "#9C1D29", "#23262f")

cp.bic %>% 
  bind_rows(pp.bic) %>% 
  bind_rows(np.bic) %>% 
  filter(., deltaBIC == 0) %>% 
  group_by(model) %>% 
  count(dist) %>% 
  mutate(prcnt_support = n/nboots) %>%
  mutate(dist = factor(dist, levels = c("gamma", "lnorm", "weibull", "multi"))) %>% 
  ggplot(., aes(x = model, y = prcnt_support, fill = dist)) +
  scale_fill_manual(values = cols.fig2) +
  geom_col() +
  theme_classic() +
  scale_y_continuous(labels = scales::percent) +
  labs(x = "Pooling Level", y = "Percent Support") +
  theme(axis.title.x = element_blank()) +
  geom_label(data = bestmodel %>%
               filter(., model == "CP"),
             aes(x = model, y = -0.05, label = dist)) -> pooling.support

# cp.boot.fits %>%
#   dplyr::select(., bic, dist, dBIC, boot) %>%
#   group_by(boot) %>%
#   distinct() %>%
#   ungroup() %>%
#   filter(dBIC == 0) %>%
#   count(dist) %>%
#   mutate(prcnt_support = n/nboots) %>%
#   mutate(model = "CP") %>%
#   ggplot(., aes(x = model, y = prcnt_support, fill = dist)) +
#   geom_col() +
#   labs(y = "Percent Support") +
#   theme_classic() +
#   theme(legend.position = "none",
#         axis.title.x = element_blank()) +
#   geom_label(data = bestmodel %>% filter(., model == "CP"),
#              aes(x = model, y = -0.05, label = dist)) +
#   scale_fill_manual(values = cols.fig2) -> cp.fit

pp.boot.fits %>%
  dplyr::select(., bic, dist, dBIC, fgroup, boot) %>%
  group_by(fgroup, boot) %>%
  distinct() %>%
  group_by(fgroup) %>%
  filter(dBIC == 0) %>%
  count(dist) %>%
  mutate(prcnt_support = n/nboots) %>%
  ggplot(., aes(x = fgroup, y = prcnt_support, fill = dist)) +
  geom_col() +
  theme_classic() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.title.x = element_blank()) +
  scale_y_continuous(labels = scales::percent) +
  geom_label(data = bestmodel %>% filter(., model == "PP"),
             aes(x = ID, y = -0.05, label = dist)) +
  scale_fill_manual(values = cols.fig2) -> pp.support

np.boot.fits %>%
  dplyr::select(., bic, dist, dBIC, individual, boot) %>%
  group_by(individual, boot) %>%
  distinct() %>%
  group_by(individual) %>%
  filter(dBIC == 0) %>%
  count(dist) %>%
  mutate(prcnt_support = n/nboots) %>%
  ggplot(., aes(x = individual, y = prcnt_support, fill = dist)) +
  geom_col() +
  theme_classic() +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank()) +
  scale_y_continuous(labels = scales::percent) +
  geom_label(data = bestmodel %>% filter(., model == "NP"),
             aes(x = ID, y = -0.05, label = dist)) +
  scale_fill_manual(values = cols.fig2)  -> np.support

# legend <- get_legend(np.fit + theme(legend.position = "bottom") +
#                        guides(fill=guide_legend(title="Distribution")))
model.legend <- get_legend(pooling.support + theme(legend.position = "bottom") +
                             guides(fill=guide_legend(title = "Distribution model")))

# plot_grid(cp.fit, pp.fit, 
#           np.fit + theme(legend.position = "none"), 
#           ncol = 3, rel_widths = c(0.8,1,1.4)) -> col_grid
# 
# plot_grid(col_grid, legend, nrow = 2, rel_heights = c(1, 0.1))

# first_row <- plot_grid(NULL, 
#                        pooling.support + theme(legend.position = "none"),
#                        NULL, rel_widths = c(0.3, 1, 0.3))
# 
# second_row <- plot_grid(pp.support, 
#                         np.support + theme(legend.position = "none"),
#                         ncol = 2, rel_widths = c(1, 1.2))
# plot_grid(pooling.support + theme(legend.position = "none"),
#           second_row, model.legend, nrow = 3, rel_heights = c(1,1,0.2))


bar_col <- plot_grid(pooling.support + theme(legend.position = "none"),
                     pp.support, 
                     np.support + theme(legend.position = "none"),
                     ncol = 3, rel_widths = c(0.4, 1, 1.4))
plot_grid(bar_col, model.legend, nrow = 2, rel_heights = c(1, 0.1))

```  




# Figure 3 

These boxplots should be showing the distribution of the BIC values for the three pooling levels with their models. 

```{r}
cp.bic %>% 
  bind_rows(pp.bic) %>% 
  bind_rows(np.bic) %>% 
  mutate(dist = factor(dist, levels = c("gamma", "lnorm", "weibull", "multi"))) %>% 
  ggplot(., aes(x = model, color = dist, y = BIC)) +
  geom_boxplot() +
  scale_color_manual(values = cols.fig2) +
  labs(x = "Pooling Model", y = "Raw BIC values") +
  theme_classic() +
  guides(color=guide_legend(title = "Distribution model")) +
  theme(legend.position = "bottom")

```






# Figure 4  

Fix this. The idea is that each bootstrap is represented here with their BIC value for each model. We see that there's very strong evidence for the multi distribution model at both PP and NP levels. The summary quantiles later show very high support for this. Difference here between incorporating variation at the expense of sample size, and getting high support, or staying with high sample size without variation.



```{r fig.height=6}

cp.bic %>% 
  mutate(dist = factor(dist, levels = c("gamma", "lnorm", "weibull", "multi"))) %>% 
  ggplot(., aes(x = deltaBIC, color = dist, y = boot)) +
  #geom_col() +
  geom_point() +
  scale_color_manual(values = cols.fig2) +
  theme_classic() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(y = "Bootstrap replicates", x = "") +
  theme(legend.position = "none") -> Fig4a

pp.bic %>% 
  mutate(dist = factor(dist, levels = c("gamma", "lnorm", "weibull", "multi"))) %>% 
  ggplot(., aes(x = deltaBIC, color = dist, y = boot)) +
  #geom_col() +
  geom_point() +
  scale_color_manual(values = cols.fig2) +
  theme_classic() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(y = "Bootstrap replicates", x = "") +
  theme(legend.position = "none") -> Fig4b

np.bic %>% 
  mutate(dist = factor(dist, levels = c("gamma", "lnorm", "weibull", "multi"))) %>% 
  ggplot(., aes(x = deltaBIC, color = dist, y = boot)) +
  #geom_col() +
  geom_point() +
  scale_color_manual(values = cols.fig2) +
  theme_classic() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(y = "Bootstrap replicates", x = "BIC units from best model") -> Fig4c

legend4 <- get_legend(Fig4c +
                       guides(color=guide_legend(title = "Distribution \n model")))

plot_grid(Fig4a, Fig4b, 
          Fig4c + theme(legend.position = "none"), nrow = 3) -> fig4

plot_grid(fig4, legend4, ncol = 2, rel_widths = c(1, 0.15))

```

On average, how many units away is the second model from the best one?  

**CP**

```{r}
cp.bic %>% 
  filter(., deltaBIC != 0) %>% 
  group_by(boot) %>% 
  summarise(min = min(deltaBIC)) %>% 
  summary()
```

**PP** 
```{r}
pp.bic %>% 
  filter(., deltaBIC != 0) %>% 
  group_by(boot) %>% 
  summarise(min = min(deltaBIC)) %>% 
  summary()
```

**NP**
```{r}
np.bic %>% 
  filter(., deltaBIC != 0) %>% 
  group_by(boot) %>% 
  summarise(min = min(deltaBIC)) %>% 
  summary()
```


What about the parameters of the best fit distributions? Meaning, that for each boostrap, keep only the best model. Plot those.

**CP**  


```{r fig.height=6}
cp.boot.fits %>% 
  filter(., dBIC == 0) %>% 
  ggplot(., aes(y = estimate)) +
  facet_wrap(dist~param, ncol = 2, scales = "free") +
  geom_boxplot()
```

**PP**  

```{r fig.height=6}
pp.boot.fits %>% 
  filter(., dBIC == 0) %>% 
  ggplot(., aes(y = estimate, x = fgroup)) +
  facet_wrap(dist~param, ncol = 2, scales = "free") +
  geom_boxplot()
```  


**NP**  


```{r fig.height=6}
np.boot.fits %>% 
  filter(., dBIC == 0) %>% 
  ggplot(., aes(y = estimate, x = individual)) +
  facet_wrap(dist~param, ncol = 2, scales = "free") +
  geom_boxplot()
```


# Visualize them as density curves:

```{r}

```


# Figure X - angles

```{r fig.width=8, fig.height=6}
p1_angles <- ptpl %>% 
  drop_na(rel.angle) %>% 
  mutate(d.angle = ifelse(rel.angle > 0, rel.angle * 180/pi,
                          rel.angle * 180/pi + 360)) %>% 
  ggplot(., aes(x = d.angle)) +
  geom_histogram(color = "grey", fill = "grey") +
  coord_polar(theta = "x", start = -pi/2, direction = -1) +
  scale_x_continuous(breaks = seq(0, 360, 30), limits = c(0, 360)) +
  theme_minimal() +
  theme(axis.title = element_blank(),
        axis.text.y = element_blank(),
        legend.position = "none") +
  labs(title = "Complete pooling")


p2_angles <- ptpl %>% 
  drop_na(rel.angle) %>% 
  mutate(d.angle = ifelse(rel.angle > 0, rel.angle * 180/pi,
                          rel.angle * 180/pi + 360)) %>% 
  ggplot(., aes(x = d.angle)) +
  geom_histogram(color = "grey", fill = "grey") +
  coord_polar(theta = "x", start = -pi/2, direction = -1) +
  scale_x_continuous(breaks = seq(0, 360, 30), limits = c(0, 360)) +
  theme_minimal() +
  theme(axis.title = element_blank(),
        axis.text.y = element_blank(),
        legend.position = "none") +
  facet_wrap(~fam_g, nrow = 2) +
  theme(axis.text = element_blank()) +
  labs(title = "Partial pooling")

p3_angles <- ptpl %>% 
  drop_na(rel.angle) %>% 
  mutate(d.angle = ifelse(rel.angle > 0, rel.angle * 180/pi,
                          rel.angle * 180/pi + 360),
         B_id = paste0("B", id)) %>% 
  ggplot(., aes(x = d.angle)) +
  geom_histogram(color = "grey", fill = "grey") +
  coord_polar(theta = "x", start = -pi/2, direction = -1) +
  scale_x_continuous(breaks = seq(0, 360, 30), limits = c(0, 360)) +
  theme_minimal() +
  theme(axis.title = element_blank(),
        axis.text.y = element_blank(),
        legend.position = "none") +
  facet_wrap(~B_id, nrow = 2) +
  theme(axis.text = element_blank()) +
  labs(title = "No pooling")

plot_grid(plot_grid(p1_angles, p2_angles), p3_angles, nrow = 2)

```


