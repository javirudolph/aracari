---
title: "Distributions"
author: "Javiera Rudolph"
output:
  html_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
# knitr::opts_chunk$set(fig.width=12, fig.height=6)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r message=FALSE, warning=FALSE}
library(aracari)
library(dplyr)
library(tidyr)
library(ggplot2)
library(cowplot)
library(fitdistrplus)
library(stringr)
library(gt)
library(MetBrewer)
library(purrr)

```


```{r LoadMovData, include=FALSE}
set.seed(20211207)

# Data ----------------------------------------------------
# The script for this data is in the Orig_data_KH
load("Ch2_distributions/Orig_data_KH/tidy_data.RData")


ptpl %>%
  mutate(T_minutes = dt/60,
         Bird_ID = id,
         mpm = dist/T_minutes,
         R2n = lead(R2n)) %>%
  filter(mpm != 0) %>%
  group_by(Bird_ID) %>%
  add_tally() %>%
  filter(n >= 30) -> ptpl
```


```{r Colors, include=FALSE}
# Color palette ----------------------------------------
my.cols1 <- c("#23262f","#717492","#b3a82a","#c94f21","#980012",
              "#0d907a","#b9bec3","#31aec5", "#653625", "#2C5C5D",
              "#DEB41E", "#2D3335", "#E2BF80", "#87A986", "#59879A",
              "#9C1D29", "#24716B", "#4a92b0")
scales::show_col(my.cols1)

my.cols2 <- c("#23262f", "#0d907a", "#DEB41E", 
              "#9C1D29", "#c76620", "#4a92b0",
              "#669e46", "grey")
scales::show_col(my.cols1)

# Colors for social groups ----------------------------------------

sgroup_col <- met.brewer("Tiepolo", n = 7)

# Colors for models --------------------------------- 

mod_col <- met.brewer("Hokusai1", n=4)
mod_col <- c("#4C6838", "#C1B489", "#8EBF72", "#91A5A0")
mod_col <- c("#264653", "#2a9d8f", "#e2b33c", "#e76f51")

scales::show_col(mod_col)
```


# Figure 1 - Density plots for velocity

<!-- Color version - each social group has a different color.   -->

```{r Figure1col, fig.width=12, fig.height=4.5}

zoom_dims <- c(90, 200, 0, 0.01)
annot_xy <- c(50, 200, 0.025, 0.045)
box_color <- "blue"
aval <- 0.6

ind_dens_plot <- ptpl %>%
  ggplot(., aes((x = mpm))) +
  geom_line(aes(x = mpm, group = id, color = sgroup), stat = "density", alpha = aval, size=1) +
  #geom_line(aes(x = mpm, group = id), color = "grey", stat = "density", alpha = 0.8) +
  geom_line(stat = "density", color = "black", size = 1.3) +
  geom_vline(xintercept = 0, color = "grey") +
  geom_hline(yintercept = 0, color = "grey") +
  labs(y = "Density", x = "Velocity in m/min") +
  # geom_segment(aes(x = zoom_dims[1], xend = zoom_dims[2], y = zoom_dims[3], yend = zoom_dims[3]), color = box_color) +
  # geom_segment(aes(x = zoom_dims[1], xend = zoom_dims[2], y = zoom_dims[4], yend = zoom_dims[4]), color = box_color) +
  # geom_segment(aes(x = zoom_dims[1], xend = zoom_dims[1], y = zoom_dims[3], yend = zoom_dims[4]), color = box_color) +
  # geom_segment(aes(x = zoom_dims[2], xend = zoom_dims[2], y = zoom_dims[3], yend = zoom_dims[4]), color = box_color) +
  theme_classic() +
  #scale_color_manual(values = my.cols2) +
  scale_color_manual(values = sgroup_col) +
  theme(legend.position = "none")

ind_dens_plot +
  coord_cartesian(
    xlim = zoom_dims[1:2],
    ylim = zoom_dims[3:4]) +
  theme(title = element_blank()) -> ind_zoom

ind_dens_plot +
  annotation_custom(grob = ggplotGrob(ind_zoom), xmin = annot_xy[1] , xmax = annot_xy[2] , ymin = annot_xy[3] , ymax = annot_xy[4]) -> a


fam_dens_plot <- ptpl %>%
  drop_na(sgroup) %>% 
  ggplot(., aes((x = mpm))) +
  geom_line(aes(x = mpm, group = sgroup, color = sgroup), stat = "density", alpha = aval, size = 1) +
  #geom_line(aes(x = mpm, group = fam_g), color = "grey",stat = "density", alpha = 0.8) +
  geom_line(stat = "density", color = "black", size = 1.3) +
  geom_vline(xintercept = 0, color = "grey") +
  geom_hline(yintercept = 0, color = "grey") +
  labs(y = "Density", x = "Velocity in m/min") +
    # geom_segment(aes(x = zoom_dims[1], xend = zoom_dims[2], y = zoom_dims[3], yend = zoom_dims[3]), color = box_color) +
  # geom_segment(aes(x = zoom_dims[1], xend = zoom_dims[2], y = zoom_dims[4], yend = zoom_dims[4]), color = box_color) +
  # geom_segment(aes(x = zoom_dims[1], xend = zoom_dims[1], y = zoom_dims[3], yend = zoom_dims[4]), color = box_color) +
  # geom_segment(aes(x = zoom_dims[2], xend = zoom_dims[2], y = zoom_dims[3], yend = zoom_dims[4]), color = box_color) +
  theme_classic() +
  #scale_color_manual(values = my.cols2) +
  scale_color_manual(values = sgroup_col) +
  theme(legend.position = "none")

fam_dens_plot +
  coord_cartesian(
    xlim = zoom_dims[1:2],
    ylim = zoom_dims[3:4]) +
  theme(title = element_blank()) -> fam_zoom


fam_dens_plot +
  annotation_custom(grob = ggplotGrob(fam_zoom), xmin = annot_xy[1] , xmax = annot_xy[2] , ymin = annot_xy[3] , ymax = annot_xy[4]) -> b

toprow <- plot_grid(b,a, labels = c("A)", "B)"))

fig1leg <- get_legend(ptpl %>%
  drop_na(sgroup) %>% 
  ggplot(., aes((x = mpm))) +
  geom_line(aes(x = mpm, group = sgroup, color = sgroup), stat = "density", alpha = aval, size = 1.1) +
  #geom_line(aes(x = mpm, group = fam_g), color = "grey",stat = "density", alpha = 0.8) +
  geom_line(stat = "density", color = "black", size = 1.2) +
  geom_vline(xintercept = 0, color = "grey") +
  geom_hline(yintercept = 0, color = "grey") +
  labs(y = "Density", x = "Velocity in m/min") +
    # geom_segment(aes(x = zoom_dims[1], xend = zoom_dims[2], y = zoom_dims[3], yend = zoom_dims[3]), color = box_color) +
  # geom_segment(aes(x = zoom_dims[1], xend = zoom_dims[2], y = zoom_dims[4], yend = zoom_dims[4]), color = box_color) +
  # geom_segment(aes(x = zoom_dims[1], xend = zoom_dims[1], y = zoom_dims[3], yend = zoom_dims[4]), color = box_color) +
  # geom_segment(aes(x = zoom_dims[2], xend = zoom_dims[2], y = zoom_dims[3], yend = zoom_dims[4]), color = box_color) +
  theme_classic() +
  #scale_color_manual(values = my.cols2) +
  scale_color_manual(values = sgroup_col) +
    guides(color = guide_legend(title = "Social group",
                                override.aes = list(alpha = 0.8)))+
    theme(legend.position = "bottom"))

#plot_grid(toprow, fig1leg, ncol = 1, rel_heights = c(1, 0.1))

#ggsave2(filename = "Ch2_distributions/Figures/Figure1_color.png")
```  


```{r fig.width=12, fig.height=4.5}
ptpl %>%
  drop_na(mpm) %>%
  filter(mpm != 0) %>%
  group_by(Bird_ID) %>%
  add_tally() %>%
  filter(n >= 30) -> nonzerompm


nonzerompm %>%
  mutate(individual = paste0("B", Bird_ID),
         individual = factor(individual, levels = c("B1", "B3", "B5", "B7", "B13", "B19", "B22", "B28", "B49", "B84", "B30", "B29"))) %>% 
  group_by(individual, T_minutes) %>%
  count() %>%
  ggplot(aes(x = individual, y = n, fill = as.factor(T_minutes))) +
  geom_bar(stat = "identity") +
  theme_classic() +
  labs(x = "Individual bird tag",
       y = "Number of intervals recorded") +
  #scale_fill_viridis_d(option = "magma", direction = -1) +
  guides(fill = guide_legend(title = "Tracking interval\n in minutes")) +
  scale_fill_manual(values = met.brewer("Hiroshige", n = 14)) +
  theme(legend.position = "none") -> np_ints

nonzerompm %>%
  mutate(individual = paste0("B", Bird_ID),
         individual = factor(individual, levels = c("B1", "B3", "B5", "B7", "B13", "B19", "B22", "B28", "B49", "B84", "B30", "B29"))) %>% 
  group_by(sgroup, T_minutes) %>%
  count() %>%
  ggplot(aes(x = sgroup, y = n, fill = as.factor(T_minutes))) +
  geom_bar(stat = "identity") +
  theme_classic() +
  labs(x = "Social group",
       y = "Number of intervals recorded") +
  #scale_fill_viridis_d(option = "magma", direction = -1) +
  guides(fill = guide_legend(title = "Tracking interval\n in minutes")) +
  scale_fill_manual(values = met.brewer("Hiroshige", n = 14)) +
  theme(legend.position = "none") -> pp_ints

legend_row <- get_legend(nonzerompm %>%
  mutate(individual = paste0("B", Bird_ID),
         individual = factor(individual, levels = c("B1", "B3", "B5", "B7", "B13", "B19", "B22", "B28", "B49", "B84", "B30", "B29"))) %>% 
  group_by(sgroup, T_minutes) %>%
  count() %>%
  ggplot(aes(x = sgroup, y = n, fill = as.factor(T_minutes))) +
  geom_bar(stat = "identity") +
  theme_classic() +
  labs(x = "Individual bird tag",
       y = "Number of intervals recorded") +
  #scale_fill_viridis_d(option = "magma", direction = -1) +
  guides(fill = guide_legend(title = "Time interval\n in minutes", nrow = 1)) +
  scale_fill_manual(values = met.brewer("Hiroshige", n = 14)) +
  theme(legend.position = "bottom"))

plot_row <- plot_grid(pp_ints, np_ints, nrow = 1, labels = c("C)", "D)"))
#plot_grid(plot_row, legend_row, ncol = 1, rel_heights = c(1, 0.1))
```

```{r Figure1, fig.height=9, fig.width=12}

a <- plot_grid(toprow, fig1leg, ncol = 1, rel_heights = c(1, 0.1))
b <- plot_grid(plot_row, legend_row, ncol = 1, rel_heights = c(1, 0.1))

plot_grid(a, NULL, b, ncol = 1, rel_heights = c(1, 0.1, 1))
ggsave2(filename = "Ch2_distributions/Figures/Figure1.png")

```

<!-- ## F1 - BW  -->

<!-- Black and white version seems more clear to me. Maybe worth including a different in the underlying curves to make sure the point comes across that one is for individuals, and the other for social groups.   -->


```{r Figure1bw,  eval = FALSE, fig.width=12, fig.height=4}

zoom_dims <- c(90, 200, 0, 0.01)
annot_xy <- c(50, 200, 0.025, 0.045)
box_color <- "blue"

ind_dens_plot <- ptpl %>%
  ggplot(., aes((x = mpm))) +
  #geom_line(aes(x = mpm, group = id, color = fam_g), stat = "density", alpha = 0.8) +
  geom_line(aes(x = mpm, group = id), color = "grey", stat = "density", alpha = 0.8) +
  geom_line(stat = "density", color = "black", lwd = 1) +
  geom_vline(xintercept = 0, color = "grey") +
  geom_hline(yintercept = 0, color = "grey") +
  labs(y = "Density", x = "Velocity in m/min") +
  # geom_segment(aes(x = zoom_dims[1], xend = zoom_dims[2], y = zoom_dims[3], yend = zoom_dims[3]), color = box_color) +
  # geom_segment(aes(x = zoom_dims[1], xend = zoom_dims[2], y = zoom_dims[4], yend = zoom_dims[4]), color = box_color) +
  # geom_segment(aes(x = zoom_dims[1], xend = zoom_dims[1], y = zoom_dims[3], yend = zoom_dims[4]), color = box_color) +
  # geom_segment(aes(x = zoom_dims[2], xend = zoom_dims[2], y = zoom_dims[3], yend = zoom_dims[4]), color = box_color) +
  theme_classic() +
  scale_color_manual(values = my.cols2) +
  theme(legend.position = "none")

ind_dens_plot +
  coord_cartesian(
    xlim = zoom_dims[1:2],
    ylim = zoom_dims[3:4]) +
  theme(title = element_blank()) -> ind_zoom

ind_dens_plot +
  annotation_custom(grob = ggplotGrob(ind_zoom), xmin = annot_xy[1] , xmax = annot_xy[2] , ymin = annot_xy[3] , ymax = annot_xy[4]) -> a


fam_dens_plot <- ptpl %>%
  drop_na(sgroup) %>% 
  ggplot(., aes((x = mpm))) +
  #geom_line(aes(x = mpm, group = fam_g, color = fam_g), stat = "density", alpha = 0.8) +
  geom_line(aes(x = mpm, group = sgroup), color = "grey",stat = "density", alpha = 0.8) +
  geom_line(stat = "density", color = "black", lwd = 1) +
  geom_vline(xintercept = 0, color = "grey") +
  geom_hline(yintercept = 0, color = "grey") +
  labs(y = "Density", x = "Velocity in m/min") +
    # geom_segment(aes(x = zoom_dims[1], xend = zoom_dims[2], y = zoom_dims[3], yend = zoom_dims[3]), color = box_color) +
  # geom_segment(aes(x = zoom_dims[1], xend = zoom_dims[2], y = zoom_dims[4], yend = zoom_dims[4]), color = box_color) +
  # geom_segment(aes(x = zoom_dims[1], xend = zoom_dims[1], y = zoom_dims[3], yend = zoom_dims[4]), color = box_color) +
  # geom_segment(aes(x = zoom_dims[2], xend = zoom_dims[2], y = zoom_dims[3], yend = zoom_dims[4]), color = box_color) +
  theme_classic() +
  scale_color_manual(values = my.cols2) +
  theme(legend.position = "none")

fam_dens_plot +
  coord_cartesian(
    xlim = zoom_dims[1:2],
    ylim = zoom_dims[3:4]) +
  theme(title = element_blank()) -> fam_zoom


fam_dens_plot +
  annotation_custom(grob = ggplotGrob(fam_zoom), xmin = annot_xy[1] , xmax = annot_xy[2] , ymin = annot_xy[3] , ymax = annot_xy[4]) -> b

plot_grid(b, a, labels = c("A)", "B)"))

ggsave2(filename = "Ch2_distributions/Figures/Figure1_bw.png")
```  

Figure 1 - Kernel density estimates for the distribution of velocity data at different pooling levels, with the dark black density curve showing complete pooling. A) Partial pooling representation of the data, where each curve displays the density of velocities across a social group. B) No pooling scenario, where each density curve is associated to a single individual's velocity data. Individuals belonging to the same social group share the line color. Plot inserts show a zoom to the tail of the distribution of velocity data in both panels. We observe considerable variation for both partial and no pooling scenarios, when compared to the single black density curve that represents the complete pooling. Particular focus towards the tails, where certain individuals possess much higher densities for large velocities, something that gets dampened when considering pooled data for velocity densities. Panels C) and D) show the variation in number of observations and the length of time intervals recorded at the group and individual level.



<!-- # Fits  -->

```{r LoadFitData}
load("Ch2_distributions/Ch2_fits.RData")
```


```{r CalcBestModel}
reg_fits_info %>% 
  dplyr::select(., dist, dBIC, ID, model) %>% 
  distinct() %>% 
  filter(., dBIC == 0) -> bestmodel

#bestmodel
```


```{r BICdist, eval=FALSE}
# Difference to the second best model

reg_fits_info %>% 
  dplyr::select(., dist, dBIC, ID, model) %>% 
  distinct() %>% 
  ggplot(., aes(x = ID, y = dBIC, color = dist)) +
  #facet_wrap(~model) +
  geom_point()

```



```{r CalcBICTable}
# Calculate the BIC for the models:

reg_fits_info %>% 
  dplyr::select(model, ID, dist, loglik, n, kpars) %>% 
  distinct() %>% 
  group_by(model, dist) %>% 
  summarise(BIC = log(sum(n))*sum(kpars) - 2 * sum(loglik)) -> A 

reg_fits_info %>% 
  filter(., model != "CP") %>% 
  dplyr::select(model, ID, dist, loglik, n, kpars, dBIC) %>% 
  distinct() %>% 
  filter(., dBIC == 0) %>% 
  group_by(model) %>% 
  summarise(BIC = log(sum(n))*sum(kpars) - 2 * sum(loglik)) %>% 
  transmute(model = model,
            dist = "Multi",
            BIC = BIC) -> B

rbind.data.frame(A, B) -> C
  

C %>%
  group_by(model) %>% 
  mutate(deltaBIC_withinmodels = signif(BIC - min(BIC), 3)) %>% 
  ungroup() %>% 
  mutate(deltaBIC_acrossmodels = signif(BIC - min(BIC), 3)) %>% 
  arrange(model) -> BIC_table
```

```{r BootstrapBIC}
cp.boot.fits %>% 
  dplyr::select(dist, bic, boot) %>% 
  distinct() %>% 
  transmute(dist = dist,
            BIC = bic,
            boot = boot,
            model = "CP") %>% 
  group_by(boot) %>% 
  mutate(., deltaBIC = signif(BIC - min(BIC), 3)) %>% 
  ungroup() -> cp.bic

pp.boot.fits %>% 
  dplyr::select(loglik, n, kpars, dist, group, boot) %>% 
  distinct() %>% 
  group_by(boot, dist) %>% 
  summarise(BIC = log(sum(n))*sum(kpars) - 2 * sum(loglik)) %>% 
  transmute(dist = dist,
            BIC = BIC,
            boot = boot,
            model = "PP") %>% 
  bind_rows(., pp.boot.fits %>% 
  dplyr::select(loglik, n, kpars, dist, group, boot, dBIC) %>% 
  distinct() %>% 
  filter(., dBIC == 0) %>% 
  group_by(boot) %>% 
  summarise(BIC = log(sum(n))*sum(kpars) - 2 * sum(loglik)) %>% 
  transmute(dist = "multi",
            BIC = BIC,
            boot = boot, 
            model = "PP")) %>% 
  group_by(boot) %>% 
  mutate(., deltaBIC = signif(BIC - min(BIC), 3)) %>% 
  ungroup() %>% 
  arrange(boot) -> pp.bic


  
np.boot.fits %>% 
  dplyr::select(loglik, n, kpars, dist, individual, boot) %>% 
  distinct() %>% 
  group_by(boot, dist) %>% 
  summarise(BIC = log(sum(n))*sum(kpars) - 2 * sum(loglik)) %>% 
  transmute(dist = dist,
            BIC = BIC,
            boot = boot,
            model = "NP") %>%   
  bind_rows(., np.boot.fits %>% 
  dplyr::select(loglik, n, kpars, dist, individual, boot, dBIC) %>% 
  distinct() %>% 
  filter(., dBIC == 0) %>% 
  group_by(boot) %>% 
  summarise(BIC = log(sum(n))*sum(kpars) - 2 * sum(loglik)) %>% 
  transmute(dist = "multi",
            BIC = BIC,
            boot = boot, 
            model = "NP")) %>% 
  group_by(boot) %>% 
  mutate(., deltaBIC = signif(BIC - min(BIC), 3)) %>% 
  ungroup() %>% 
  arrange(boot) -> np.bic



```
# Table 1 - BIC values for models across pooling levels  

Table 1 - BIC values obtained for models fitted to velocity data across pooling levels. Probability density functions considered included the Gamma, Weibull, and Lognormal distributions. Multi distribution models selected the best fitting distribution model for each social group or individual, allowing for variation not only in estimated parameters, but also in the distribution used. Based on BIC values, the best fitting model is the Multi-distribution with Partial Pooling, followed by the Lognormal PP, and Lognormal CP. 


```{r GenerateBICtable}

BIC_table %>% 
  mutate(dist = ifelse(dist == "lnorm", "lognormal", dist),
         dist = str_to_title(dist)) %>% 
  mutate(model = factor(model, levels = c("CP", "PP", "NP"))) %>% 
  arrange(., model) -> BIC_table

BIC_table
write.csv(BIC_table, file = "Ch2_distributions/Figures/bic_table.csv")

```

```{r Generate_gt_Table, eval=FALSE}

library(gt)

gt_tbl <- gt(BIC_table[, 2:5], rowname_col = "dist")


gt_tbl %>% 
  tab_header(
    title = md("**Model comparisons across levels**")
  ) %>% 
  tab_stubhead(label = "Model") %>% 
  tab_row_group(
    group = "NP",
    rows = 8:11
  ) %>% 
  tab_row_group(
    group = "PP",
    rows = 4:7
  ) %>% 
  tab_row_group(
    group = "CP", 
    rows = 1:3
  ) %>% 
  tab_spanner(
    label = md("**BIC**"),
    columns = vars(BIC, deltaBIC_withinmodels, deltaBIC_acrossmodels)
  ) %>% 
  cols_label(
    deltaBIC_withinmodels = html("&Delta; BIC<sub>within</sub>"),
    deltaBIC_acrossmodels = html("&Delta; BIC<sub>across</sub>"),
  ) -> gt_table_bic

gtsave(gt_table_bic, "Ch2_distributions/Figures/bic_table.png")
```


```{r eval = FALSE}
knitr::include_graphics("Ch2_distributions/aic_bic_table.png")
```



# Figure 2 - Best fit parameters

To tell the same story, we see variation in the parameters estimated for each bootstrap under various models.  


```{r Bootstrap_dBICzero}

cp.boot.fits %>%
  filter(., dBIC == 0) %>% 
  dplyr::select(boot, estimate, param, dist) %>% 
  pivot_wider(names_from = param, values_from = estimate) -> cp.best


pp.boot.fits %>%
  filter(., dBIC == 0) %>% 
  dplyr::select(group, boot, estimate, param, dist) %>% 
  pivot_wider(names_from = param, values_from = estimate) %>% 
  mutate(group = as.factor(group)) -> pp.best

np.boot.fits %>%
  filter(., dBIC == 0) %>% 
  dplyr::select(individual, boot, estimate, param, dist) %>% 
  pivot_wider(names_from = param, values_from = estimate) %>% 
  mutate(id = str_remove(individual, "B"), 
         group = case_when(
    id %in% c(1,3,5) ~ "G1",
    id %in% c(7) ~ "G2",
    id %in% c(13, 19) ~ "G3",
    id %in% c(22) ~ "G4",
    id %in% c(28) ~ "G5",
    id %in% c(49, 84) ~ "G6",
    id %in% c(29, 30) ~ "G7"
  )) %>%
  #slice_sample(., n = 100) %>%
  mutate(group = as.factor(group)) %>% 
  arrange(group) %>% 
  group_by(group) %>% 
  mutate(shapeid = as.character(as.numeric(as.factor(individual)))) -> np.best
#View(np.best)


# What values to use
# map_dbl(cp.best[,-c(1,2)], min, na.rm = TRUE)
# map_dbl(cp.best[,-c(1,2)], max, na.rm = TRUE)
# map_dbl(pp.best[,-c(1:3)], min, na.rm = TRUE)
# map_dbl(pp.best[,-c(1:3)], max, na.rm = TRUE)
# map_dbl(np.best[,c(4:8)], min, na.rm = TRUE)
# map_dbl(np.best[,c(4:8)], max, na.rm = TRUE)

```


```{r Figure2, fig.height=9, fig.width=9}

#colsx <- met.brewer("Tiepolo", n = 7)
aval <- 0.5

figx.theme <- theme_bw() +
  theme(legend.position = "none",
        axis.title = element_text(size = 8))

cp.best %>% 
  filter(., dist == "lnorm") %>% 
  ggplot(., aes(x = meanlog, y = sdlog)) +
  geom_point(alpha = aval) +
  lims(x = c(0.7, 3.7), y = c(0.5, 2.1)) +
  labs(subtitle = "CP - lnorm") +
  figx.theme -> cp.ln

cp.best %>%
  filter(., dist == "weibull") %>% 
  ggplot(., aes(x = scale, y = shape)) +
  geom_point(alpha = aval) +
  lims(x = c(5, 80), y = c(0, 2.1)) +
  labs(subtitle = "CP - weibull") +
  figx.theme -> cp.wei

cp.grid <- plot_grid(cp.ln, cp.wei, ncol = 2, labels = c("A)", "B)"), label_size = 9)

pp.best %>% 
  filter(., dist == "gamma") %>% 
  ggplot(., aes(x = rate, y = shape, color = group)) +
  geom_point(alpha = aval) +
  scale_color_manual(values=sgroup_col, drop=FALSE) +
  lims(x = c(0, 0.23), y = c(0.4, 2.3)) +
  labs(subtitle = "PP - gamma") +
  figx.theme -> pp.gam

pp.best %>%
  filter(., dist == "lnorm") %>% 
  ggplot(., aes(x = meanlog, y = sdlog, color = group)) +
  geom_point(alpha = aval) +
  scale_color_manual(values=sgroup_col, drop=FALSE) +
  lims(x = c(0.7, 3.7), y = c(0.5, 2.1)) +
  labs(subtitle = "PP - lnorm") +
  figx.theme -> pp.ln

pp.best %>%
  filter(., dist == "weibull") %>% 
  ggplot(., aes(x = scale, y = shape, color = group)) +
  geom_point(alpha = aval) +
  scale_color_manual(values=sgroup_col, drop=FALSE) +
  lims(x = c(5, 80), y = c(0, 2.1)) +
  labs(subtitle = "PP - weibull") +
  figx.theme -> pp.wei

pp.grid <- plot_grid(pp.gam, pp.ln, pp.wei, nrow = 1, labels = c("C)", "D)", "E)"), label_size = 9)


np.best %>% 
  filter(., dist == "gamma") %>% 
  ggplot(., aes(x = rate, y = shape, color = group, shape = shapeid)) +
  geom_point(alpha = aval) +
  scale_color_manual(values=sgroup_col, drop=FALSE) +
  lims(x = c(0, 0.23), y = c(0.4, 2.3)) +
  labs(subtitle = "NP - gamma") +
  figx.theme -> np.gam

np.best %>% 
  filter(., dist == "lnorm") %>% 
  ggplot(., aes(x = meanlog, y = sdlog, color = group, shape = shapeid)) +
  geom_point(alpha = aval) +
  scale_color_manual(values=sgroup_col, drop=FALSE) +
  lims(x = c(0.7, 3.7), y = c(0.5, 2.1)) +
  labs(subtitle = "NP - lnorm") +
  figx.theme -> np.ln

np.best %>%
  filter(., dist == "weibull") %>% 
  ggplot(., aes(x = scale, y = shape, color = group, shape = shapeid)) +
  geom_point(alpha = aval) +
  scale_color_manual(values=sgroup_col, drop=FALSE) +
  lims(x = c(5, 80), y = c(0, 2.1)) +
  labs(subtitle = "NP - weibull") +
  figx.theme -> np.wei

np.grid <- plot_grid(np.gam, np.ln, np.wei, nrow = 1, labels = c("F)", "G)", "H)"), label_size = 9)


legend.grid <- get_legend(pp.best %>%
  filter(., dist == "lnorm") %>% 
  ggplot(., aes(x = meanlog, y = sdlog, color = group)) +
  geom_point(alpha = aval) +
  scale_color_manual(values=sgroup_col, drop=FALSE) +
  lims(x = c(0.7, 3.7), y = c(0.5, 2.1)) +
  theme_bw() +
  guides(color = guide_legend(title = "Social Group", ncol = 2,
                              override.aes = list(alpha = 0.9, size = 5))))

#cp.grid <- plot_grid(legend.grid, cp.ln, cp.wei, ncol = 3)
row1 <- plot_grid(legend.grid, cp.grid, ncol = 2, rel_widths = c(1,2))

plot_grid(row1, pp.grid, np.grid, nrow = 3)

ggsave2(filename = "Ch2_distributions/Figures/Figure2.png")
``` 

Figure 2 -Parameter space for best fitting models under the three pooling scenarios for 1000 bootstrap replicas. Complete pooling approaches showed best fitting models under the lognormal (panel A.) and weibull (B.) distributions, but no models under a gamma distribution. C)-E) Panels show placement of best fitting models under the three distributions with each color representing a different social group. Under the NP scenario (panels F.-H.) individuals belongig to the same social group are represented with a different shape. 

# Figure 3 - Percent Support


```{r Figure3, fig.width=12, fig.height=5}

cols.fig2 <- c("#b9bec3", 
               "#0d907a", "#DEB41E", "#9C1D29", "#23262f")

cp.bic %>% 
  bind_rows(pp.bic) %>% 
  bind_rows(np.bic) %>% 
  filter(., deltaBIC == 0) %>% 
  group_by(model) %>% 
  count(dist) %>% 
  mutate(prcnt_support = n/nboots) %>%
  mutate(dist = factor(dist, levels = c("gamma", "lnorm", "weibull", "multi")),
         model = factor(model, levels = c("CP", "PP", "NP"))) %>% 
  ggplot(., aes(x = model, y = prcnt_support, fill = dist)) +
  #scale_fill_manual(values = cols.fig2, drop = FALSE) +
  scale_fill_manual(values = mod_col, drop = FALSE) +
  geom_col() +
  theme_classic() +
  scale_y_continuous(labels = scales::percent) +
  labs(x = "Pooling Level", y = "Percent Support") +
  theme(axis.title.x = element_blank()) +
  geom_label(data = bestmodel %>%
               filter(., model == "CP"),
             aes(x = model, y = -0.05, label = dist), size = 2.5) -> pooling.support

# cp.boot.fits %>%
#   dplyr::select(., bic, dist, dBIC, boot) %>%
#   group_by(boot) %>%
#   distinct() %>%
#   ungroup() %>%
#   filter(dBIC == 0) %>%
#   count(dist) %>%
#   mutate(prcnt_support = n/nboots) %>%
#   mutate(model = "CP") %>%
#   ggplot(., aes(x = model, y = prcnt_support, fill = dist)) +
#   geom_col() +
#   labs(y = "Percent Support") +
#   theme_classic() +
#   theme(legend.position = "none",
#         axis.title.x = element_blank()) +
#   geom_label(data = bestmodel %>% filter(., model == "CP"),
#              aes(x = model, y = -0.05, label = dist)) +
#   scale_fill_manual(values = cols.fig2) -> cp.fit

pp.boot.fits %>%
  dplyr::select(., bic, dist, dBIC, group, boot) %>%
  group_by(group, boot) %>%
  distinct() %>%
  group_by(group) %>%
  filter(dBIC == 0) %>%
  count(dist) %>%
  mutate(prcnt_support = n/nboots) %>%
  ggplot(., aes(x = group, y = prcnt_support, fill = dist)) +
  geom_col() +
  theme_classic() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.title.x = element_blank()) +
  scale_y_continuous(labels = scales::percent) +
  geom_label(data = bestmodel %>% filter(., model == "PP"),
             aes(x = ID, y = -0.05, label = dist), size = 2.5) +
  #scale_fill_manual(values = cols.fig2) +
  scale_fill_manual(values = mod_col, drop = FALSE) +
  NULL -> pp.support

np.boot.fits %>%
  dplyr::select(., bic, dist, dBIC, individual, boot) %>%
  group_by(individual, boot) %>%
  distinct() %>%
  group_by(individual) %>%
  filter(dBIC == 0) %>%
  count(dist) %>%
  mutate(prcnt_support = n/nboots,
         individual = factor(individual, levels = c("B1", "B3", "B5", "B7", "B13", "B19", "B22", "B28", "B49", "B84", "B30", "B29"))) %>%
  ggplot(., aes(x = individual, y = prcnt_support, fill = dist)) +
  geom_col() +
  theme_classic() +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank()) +
  scale_y_continuous(labels = scales::percent) +
  geom_label(data = bestmodel %>% filter(., model == "NP"),
             aes(x = ID, y = -0.05, label = dist), size = 2.5) +
  #scale_fill_manual(values = cols.fig2) +
  scale_fill_manual(values = mod_col, drop = FALSE) +
  NULL -> np.support

# legend <- get_legend(np.fit + theme(legend.position = "bottom") +
#                        guides(fill=guide_legend(title="Distribution")))
model.legend <- get_legend(pooling.support + theme(legend.position = "bottom") +
                             guides(fill=guide_legend(title = "Distribution model")))

# plot_grid(cp.fit, pp.fit, 
#           np.fit + theme(legend.position = "none"), 
#           ncol = 3, rel_widths = c(0.8,1,1.4)) -> col_grid
# 
# plot_grid(col_grid, legend, nrow = 2, rel_heights = c(1, 0.1))

# first_row <- plot_grid(NULL, 
#                        pooling.support + theme(legend.position = "none"),
#                        NULL, rel_widths = c(0.3, 1, 0.3))
# 
# second_row <- plot_grid(pp.support, 
#                         np.support + theme(legend.position = "none"),
#                         ncol = 2, rel_widths = c(1, 1.2))
# plot_grid(pooling.support + theme(legend.position = "none"),
#           second_row, model.legend, nrow = 3, rel_heights = c(1,1,0.2))


bar_col <- plot_grid(pooling.support + theme(legend.position = "none"),
                     pp.support, 
                     np.support + theme(legend.position = "none"),
                     ncol = 3, rel_widths = c(0.4, 1, 1.4), 
                     labels = c("A)", "B)", "C)"), label_size = 10)
plot_grid(bar_col, model.legend, nrow = 2, rel_heights = c(1, 0.1))

ggsave2(filename = "Ch2_distributions/Figures/Figure3.png")

```   

Figure 3 - Percent support for the different distribution models at the three pooling levels. Percent support is based on 1000 bootstrapped replicas for each scenario. Labels on the x axis show the best fitting model for the original datasets. A) percent support at the three pooling levels, with CP having over 50% support for the lognormal distribution, in agreement with the model fit to the complete dataset. PP and NP scenarios show 100% support for the multi-distribution model, which considers the best fitting model for each family group or individual, respectively. B) Percent support for each model in the family groups. C) Support for each model at the individual level.  


```{r BICboxplots, eval=FALSE}
# These boxplots should be showing the distribution of the BIC values for the three pooling levels with their models. 

cp.bic %>% 
  bind_rows(pp.bic) %>% 
  bind_rows(np.bic) %>% 
  mutate(dist = factor(dist, levels = c("gamma", "lnorm", "weibull", "multi"))) %>% 
  ggplot(., aes(x = model, color = dist, y = BIC)) +
  geom_boxplot() +
  scale_color_manual(values = cols.fig2) +
  labs(x = "Pooling Model", y = "Raw BIC values") +
  theme_classic() +
  guides(color=guide_legend(title = "Distribution model")) +
  theme(legend.position = "bottom")

``` 



# Figure 4 - BIC units from best model

<!-- Fix this. The idea is that each bootstrap is represented here with their BIC value for each model. We see that there's very strong evidence for the multi distribution model at both PP and NP levels. The summary quantiles later show very high support for this. Difference here between incorporating variation at the expense of sample size, and getting high support, or staying with high sample size without variation. -->



```{r eval=FALSE, fig.height=4}

cp.bic %>% 
  mutate(dist = factor(dist, levels = c("gamma", "lnorm", "weibull", "multi"))) %>% 
  ggplot(., aes(x = deltaBIC, color = dist, y = boot)) +
  #geom_col() +
  geom_point(alpha = 0.8, shape = 15) +
  #scale_color_manual(values = cols.fig2) +
  scale_color_manual(values = mod_col, drop = FALSE) +
  theme_classic() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(y = "Bootstrap \n replicates", x = "") +
  theme(legend.position = "none") -> Fig4a

pp.bic %>% 
  mutate(dist = factor(dist, levels = c("gamma", "lnorm", "weibull", "multi"))) %>% 
  ggplot(., aes(x = deltaBIC, color = dist, y = boot)) +
  #geom_col() +
  geom_point(alpha = 0.8, shape = 15) +
  #scale_color_manual(values = cols.fig2) +
  scale_color_manual(values = mod_col, drop = FALSE) +
  theme_classic() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(y = "Bootstrap \n replicates", x = "") +
  theme(legend.position = "none") -> Fig4b

np.bic %>% 
  mutate(dist = factor(dist, levels = c("gamma", "lnorm", "weibull", "multi"))) %>% 
  ggplot(., aes(x = deltaBIC, color = dist, y = boot)) +
  #geom_col() +
  geom_point(alpha = 0.8, shape = 15) +
  #scale_color_manual(values = cols.fig2) +
  scale_color_manual(values = mod_col, drop = FALSE) +
  theme_classic() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(y = "Bootstrap \n replicates", x = "BIC units from best model") -> Fig4c

legend4 <- get_legend(Fig4c +
                       guides(color=guide_legend(title = "Distribution \n model")))

plot_grid(Fig4a, Fig4b, 
          Fig4c + theme(legend.position = "none"), nrow = 3) -> fig4

plot_grid(fig4, legend4, ncol = 2, rel_widths = c(1, 0.15))

```


```{r eval=FALSE, fig.height=4}
cp.bic %>% 
  bind_rows(., pp.bic) %>% 
  bind_rows(., np.bic) %>% 
  mutate(dist = factor(dist, levels = c("gamma", "lnorm", "weibull", "multi")),
         model = factor(model, levels = c("CP", "PP", "NP"))) %>% 
  ggplot(., aes(x = deltaBIC, color = dist, y = boot)) +
  facet_wrap(~model, nrow = 3) +
  #geom_col() +
  geom_point(alpha = 0.9, shape = 15, size = 0.9) +
  #scale_color_manual(values = cols.fig2) +
  scale_color_manual(values = mod_col, drop = FALSE) +
  theme_classic() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(y = "Bootstrap replicates", x = "BIC units from best model") +
  theme(legend.position = "right") +
  guides(color=guide_legend(title = "Distribution \n model", override.aes = list(size = 5))) 

#ggsave2(filename = "Ch2_distributions/Figures/Figure4.png")
``` 



```{r Figure4}

cp.bic %>% 
  bind_rows(., pp.bic) %>% 
  bind_rows(., np.bic) %>% 
  mutate(dist = factor(dist, levels = c("gamma", "lnorm", "weibull", "multi")),
         model = factor(model, levels = c("CP", "PP", "NP"))) -> all.bic
  
all.bic %>% 
  filter(., deltaBIC != 0) %>% 
  ggplot(., aes(x = model, y = deltaBIC)) +
  #geom_violin() +
  #geom_boxplot(width = 0.4, coef = 0, outlier.shape = NA) +
  geom_jitter(data = all.bic, 
              #%>% group_by(model) %>% slice_sample(n=400),
              aes(x = model, y = deltaBIC, color = dist), width = 0.3, alpha = 0.6) +
  #geom_boxplot(color = "black", width = 0.4, fill = "white", alpha = 0.8) +
  geom_violin(color = "black", width = 0.4, fill = "white", alpha = 0.6) +
  geom_boxplot(width = 0.1, coef = 0, outlier.shape = NA) +
  scale_color_manual(values = mod_col, drop = FALSE) +
  theme_classic() + 
  labs(x = "", y = "BIC units from best model") +
  theme(legend.position = "bottom") +
  guides(color=guide_legend(title = "Distribution", override.aes = list(size = 5, alpha = 0.9))) 

ggsave2(filename = "Ch2_distributions/Figures/Figure4.png")

```

Figure 4 - Distributions of $\Delta BIC$ values for models under the three different pooling scenarios. Best fit model is aligned at y = 0, thus in the case of the PP and NP scenario, the orange bar at y=0 is actually the $\Delta BIC$ value being zero for the multi-distribution model for all bootstraps. The violin plots describe the density of $\Delta BIC$ units away from the best model. The box overlay shows the median, and lower and upper quartiles of this distribution for the three different pooling levels. 

# Table 2 - Average BIC units from best model

Table 2 - Mean and median distance for second best model in BIC units, for each of the pooling scenarios.

```{r Table2}
# cp.bic %>% 
#   filter(., deltaBIC != 0) %>% 
#   group_by(boot) %>% 
#   summarise(min = min(deltaBIC)) %>% 
#   summary()
# 
# pp.bic %>% 
#   filter(., deltaBIC != 0) %>% 
#   group_by(boot) %>% 
#   summarise(min = min(deltaBIC)) %>% 
#   summary()
# 
# np.bic %>% 
#   filter(., deltaBIC != 0) %>% 
#   group_by(boot) %>% 
#   summarise(min = min(deltaBIC)) %>% 
#   summary()


cp.bic %>% 
  bind_rows(pp.bic) %>% 
  bind_rows(np.bic) %>% 
  filter(., deltaBIC != 0) %>% 
  mutate(model = factor(model, levels = c("CP", "PP", "NP"))) %>% 
  group_by(model, boot) %>% 
  summarise(min = min(deltaBIC)) %>% 
  group_by(model) %>% 
  summarise(minimum = min(min),
            median = median(min),
            mean = mean(min),
            q2.5 = quantile(min, probs = 0.025),
            q97.5 = quantile(min, probs = 0.975)) -> bic_2nd

bic_2nd

write.csv(bic_2nd, file = "Ch2_distributions/Figures/bic_2nd.csv")

```




# Figure 5 - angles

```{r Figure5, fig.width=8, fig.height=6}
p1_angles <- ptpl %>% 
  drop_na(rel.angle) %>% 
  mutate(d.angle = ifelse(rel.angle > 0, rel.angle * 180/pi,
                          rel.angle * 180/pi + 360)) %>% 
  ggplot(., aes(x = d.angle)) +
  geom_histogram(color = "grey", fill = "grey") +
  coord_polar(theta = "x", start = -pi/2, direction = -1) +
  scale_x_continuous(breaks = seq(0, 360, 30), limits = c(0, 360)) +
  theme_minimal() +
  theme(axis.title = element_blank(),
        axis.text.y = element_blank(),
        legend.position = "none") +
  labs(title = "Complete pooling")


p2_angles <- ptpl %>% 
  drop_na(rel.angle) %>% 
  mutate(d.angle = ifelse(rel.angle > 0, rel.angle * 180/pi,
                          rel.angle * 180/pi + 360)) %>% 
  ggplot(., aes(x = d.angle)) +
  geom_histogram(color = "grey", fill = "grey") +
  coord_polar(theta = "x", start = -pi/2, direction = -1) +
  scale_x_continuous(breaks = seq(0, 360, 30), limits = c(0, 360)) +
  theme_minimal() +
  theme(axis.title = element_blank(),
        axis.text.y = element_blank(),
        legend.position = "none") +
  facet_wrap(~sgroup, nrow = 2) +
  theme(axis.text = element_blank()) +
  labs(title = "Partial pooling")

p3_angles <- ptpl %>% 
  drop_na(rel.angle) %>% 
  mutate(d.angle = ifelse(rel.angle > 0, rel.angle * 180/pi,
                          rel.angle * 180/pi + 360),
         B_id = paste0("B", id)) %>% 
  ggplot(., aes(x = d.angle)) +
  geom_histogram(color = "grey", fill = "grey") +
  coord_polar(theta = "x", start = -pi/2, direction = -1) +
  scale_x_continuous(breaks = seq(0, 360, 30), limits = c(0, 360)) +
  theme_minimal() +
  theme(axis.title = element_blank(),
        axis.text.y = element_blank(),
        legend.position = "none") +
  facet_wrap(~Bird_ID, nrow = 2) +
  theme(axis.text = element_blank()) +
  labs(title = "No pooling")

plot_grid(plot_grid(p1_angles, p2_angles), p3_angles, nrow = 2)

ggsave("Ch2_distributions/Figures/Figure5.png")

```

```{r}


# Relative angle requires at least three consecutive observations since it is looking at changes in direction. Whereas, the absolute angle is just the direction of movement based on the absolute plane, and thus it only requires two consecutive observations. 
ptpl %>% 
  ungroup() %>% 
  mutate(individual = paste0("B", Bird_ID),
         individual = factor(individual, levels = c("B1", "B3", "B5", "B7", "B13", "B19", "B22", "B28", "B49", "B84", "B30", "B29"))) %>% 
  dplyr::select(individual, sgroup, rel.angle, abs.angle) -> angles_df
```

```{r eval = FALSE}
p1_angles <- angles_df %>% 
  drop_na(abs.angle) %>% 
  mutate(d.angle = ifelse(abs.angle > 0, abs.angle * 180/pi,
                          abs.angle * 180/pi + 360)) %>% 
  ggplot(., aes(x = d.angle)) +
  geom_histogram(color = "grey", fill = "grey") +
  coord_polar(theta = "x", start = -pi/2, direction = -1) +
  scale_x_continuous(breaks = seq(0, 360, 30), limits = c(0, 360)) +
  theme_minimal() +
  theme(axis.title = element_blank(),
        axis.text.y = element_blank(),
        legend.position = "none") +
  labs(title = "Complete pooling")


p2_angles <- angles_df %>% 
  drop_na(abs.angle) %>% 
  mutate(d.angle = ifelse(abs.angle > 0, abs.angle * 180/pi,
                          abs.angle * 180/pi + 360)) %>% 
  ggplot(., aes(x = d.angle)) +
  geom_histogram(color = "grey", fill = "grey") +
  coord_polar(theta = "x", start = -pi/2, direction = -1) +
  scale_x_continuous(breaks = seq(0, 360, 30), limits = c(0, 360)) +
  theme_minimal() +
  theme(axis.title = element_blank(),
        axis.text.y = element_blank(),
        legend.position = "none") +
  facet_wrap(~sgroup, nrow = 2) +
  theme(axis.text = element_blank()) +
  labs(title = "Partial pooling")

p3_angles <- angles_df %>% 
  drop_na(abs.angle) %>% 
  mutate(d.angle = ifelse(abs.angle > 0, abs.angle * 180/pi,
                          abs.angle * 180/pi + 360)) %>% 
  ggplot(., aes(x = d.angle)) +
  geom_histogram(color = "grey", fill = "grey") +
  coord_polar(theta = "x", start = -pi/2, direction = -1) +
  scale_x_continuous(breaks = seq(0, 360, 30), limits = c(0, 360)) +
  theme_minimal() +
  theme(axis.title = element_blank(),
        axis.text.y = element_blank(),
        legend.position = "none") +
  facet_wrap(~ individual, nrow = 2) +
  theme(axis.text = element_blank()) +
  labs(title = "No pooling")

plot_grid(plot_grid(p1_angles, p2_angles), p3_angles, nrow = 2)
```

```{r}

library(CircStats)

ptpl %>%
  drop_na(rel.angle) %>% 
  group_by(Bird_ID) %>%
  add_tally() %>%
  filter(n >= 30)  %>% 
  mutate(individual = paste0("B", Bird_ID),
         individual = factor(individual, levels = c("B1", "B3", "B5", "B7", "B13", "B19", "B22", "B28", "B49", "B84", "B30", "B29"))) %>% 
  dplyr::select(individual, sgroup, rel.angle, abs.angle) %>%
  drop_na(individual, rel.angle) -> angles_df

# Estimate for complete pooling

mu0 <- circ.mean(angles_df$rel.angle)
rho0 <- est.rho(angles_df$rel.angle)
angle.params <- as.data.frame(wrpcauchy.ml(angles_df$rel.angle, mu0 = mu0, rho0 = rho0)) %>%
  mutate(model = "CP",
         group = NA)


# Partial pooling

sgroups <- paste0("G", 1:7)



for(i in 1:7){

  sub_data <- angles_df %>%
    drop_na(rel.angle) %>%
    filter(., sgroup == sgroups[i])

  mu0 <- circ.mean(sub_data$rel.angle)
  rho0 <- est.rho(sub_data$rel.angle)
  a <- as.data.frame(wrpcauchy.ml(sub_data$rel.angle, mu0 = mu0, rho0 = rho0)) %>%
    mutate(model = "PP",
           group = sgroups[i])

  angle.params <- rbind.data.frame(angle.params, a)

}

# No pooling

individuals <- unique(angles_df$individual)



for(i in 1:12){

  sub_data <- angles_df %>%
    drop_na(rel.angle) %>%
    filter(., individual == individuals[i])

  mu0 <- circ.mean(sub_data$rel.angle)
  rho0 <- est.rho(sub_data$rel.angle)
  a <- as.data.frame(wrpcauchy.ml(sub_data$rel.angle, mu0 = mu0, rho0 = rho0)) %>%
    mutate(model = "NP",
           group = individuals[i])

  angle.params <- rbind.data.frame(angle.params, a)

}

```

```{r Figure6, fig.width=6, fig.height=3}
cp.mu <- angle.params$mu[which(angle.params$model=="CP")]
cp.rho <- angle.params$rho[which(angle.params$model=="CP")]

angle.params %>% 
  mutate(id = ifelse(str_detect(group, "B"), str_replace(group, "B", ""), group),
         id = case_when(
    id %in% c(1,3,5) ~ "G1",
    id %in% c(7) ~ "G2",
    id %in% c(13, 19) ~ "G3",
    id %in% c(22) ~ "G4",
    id %in% c(28) ~ "G5",
    id %in% c(49, 84) ~ "G6",
    id %in% c(29, 30) ~ "G7",
    str_detect(id, "G") ~ id
  ),
  id = as.factor(id)) -> angle.params

angle.params %>% 
  filter(., model != "CP") %>% 
  ggplot(., aes(x = model, y = mu)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, aes(color = id)) +
  scale_color_manual(values=sgroup_col, drop=FALSE) +
  geom_hline(yintercept = cp.mu, color = my.cols1[4], size = 1) +
  labs(x = "Pooling scenario") +
  theme_classic() +
  theme(legend.position = "none") -> muplot

angle.params %>% 
  filter(., model != "CP") %>% 
  ggplot(., aes(x = model, y = rho)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, aes(color = id)) +
  scale_color_manual(values=sgroup_col, drop=FALSE) +
  geom_hline(yintercept = cp.rho, color = my.cols1[4], size = 1) +
  labs(x = "Pooling scenario") +
  theme_classic() +
  theme(legend.position = "none") -> rhoplot

cir.legend <- get_legend(angle.params %>% 
  filter(., model != "CP") %>% 
  ggplot(., aes(x = model, y = rho)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, aes(color = id)) +
  scale_color_manual(values=sgroup_col, drop=FALSE) +
  guides(color = guide_legend(title = "Social \n group")) +
  geom_hline(yintercept = cp.rho, color = my.cols1[4], size = 1) +
  labs(x = "Pooling scenario") +
  theme_classic())

A <- plot_grid(muplot, rhoplot, nrow = 1, labels = c("A)", "B)"), label_size = 10)
plot_grid(A, cir.legend, nrow = 1, rel_widths = c(1, 0.1))

ggsave("Ch2_distributions/Figures/Figure6.png")
```

