---
title: "Extreme Value Chapter"
author: "Javiera Rudolph"
output:
  html_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
# knitr::opts_chunk$set(fig.width=12, fig.height=6)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r libraries}
library(dplyr)
library(ggplot2)
library(cowplot)
library(tidyr)
library(purrr)
library(MetBrewer)
library(stringr)
```

```{r loadData}
path <- "Ch3_samplesize/original/"
load(paste0(path, "mixturesamples.RData"))
load(paste0(path, "nreps_mles_df.RData"))
load(paste0(path, "nonpar_glm.RData"))
load(paste0(path, "par_glm.RData"))
load(paste0(path, "GP_runs.RData"))

source("Ch3_samplesize/Ch3_functions.R")
```

```{r}
# Color palettes

pal_sampsize <- met.brewer("Hokusai3", n = 6)
pal_threshold <- met.brewer("Derain", n = 7)
pal_mixture <- met.brewer("Hokusai1", n = 4)
theta_color <- "steelblue"

```


# Figure 1

The mixture distribution used to generate the data: 

```{r fig.width=12, fig.height=8}
desired_means <- c(28, 32, 40, 50)
desired_sds <- c(49.7, 39.9, 33.3, 31.1)
pars <- desired_mean_sd(mu_x = desired_means, sd_x = desired_sds)
# These are the weights for the distribution
pis <- c( 0.1, 0.2, 0.3, 0.4)

# The color associated to each mixture component
dens_cols <- c("#264653", "#2a9d8f", "#f4a261", "#e76f51")

# Build the densities for plotting
weighted_densities <- purrr::map(1:4, function(y) stat_function(fun = dlnorm, args = list(meanlog = pars$meanlog[y], sdlog = pars$sdlog[y]), color = dens_cols[y], size=pis[y]*5, alpha = 0.8))

# Plot density components of the mixture
ggplot() +
  weighted_densities +
  theme_minimal() +
  labs(y = "Density") +
  lims(x = c(0, 150)) -> densities_plot
# densities_plot

# Plot the means and sd for each of the curves
data.frame(desired_means, desired_sds, gID = factor(1:4)) %>%
  mutate(lo = desired_means - desired_sds,
         hi = desired_means + desired_sds) %>%
  ggplot(., aes(x = gID, y = desired_means, color = gID)) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = lo, ymax = hi), width = 0.1, size = 1) +
  scale_color_manual(values = dens_cols) +
  labs(y = "Mean +/- SD") +
  theme_minimal() +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        legend.position = "none") -> means_sd_plot
# means_sd_plot

# Align these plots to have multiple panels lates
top_row <- plot_grid(densities_plot, means_sd_plot, rel_widths = c(2,1))

tru_tail <- data.frame(values = truth_df$x_samps, y = 100) %>% arrange(desc(values)) %>% filter(values >=50)

# Histogram plus the points in the tail.
truth_df %>%
  ggplot(., aes(x = x_samps)) +
  geom_histogram(bins = 100) +
  geom_point(data = tru_tail[1:50,], aes(x = values, y = y), color = "black", alpha = 0.5) +
  labs(y = "Frequency", x = "Distance") +
  #lims(x = c(0, 150)) +
  theme_minimal() -> truth_hist
# truth_hist

# Density curve for the mixture based on the 50k samples.
truth_df %>%
  ggplot(., aes(x = x_samps)) +
  geom_density() +
  labs(y = "Density", x = "Distance") +
  lims(x = c(0, 150), y = c(0,0.05)) +
  theme_minimal() -> truth_density
# truth_density

# Visualize both in one frame
# plot_grid(truth_hist, truth_density)

## Figure 1 -----------------------------

bottom_row <- plot_grid(truth_hist, truth_density)

plot_grid(top_row, bottom_row,nrow = 2)

```


```{r}
# Stuff needed for plots later

# TEST VALUES --------------------------------------
## Thresholds ----------------
# Thresholds based on quantiles: because when we have a sample, we still don't know the truth
# But we can know the quantiles of our sample.
# summary(truth_df$x_samps)
# thresh_tests <- round(quantile(truth_df$x_samps, c(0.5, 0.75, 0.9, 0.99, 0.999, 0.9999), names = FALSE))
tru_n <- 50000
w_samp_sizes <- pis*tru_n

thresh_tests <- c(50, 100, 150, 250, 500, 750, 1000)
tibble(thresh_tests) %>%
  mutate(n_overthresh = map_dbl(1:length(thresh_tests),
                                function(y) length(which(truth_df$x_samps >= thresh_tests[y]))),
         theta = n_overthresh/tru_n) -> thetas

## Sample sizes --------------------
samp_n_tests <- c(80, 200, 500, 800, 1000, 1600)

all_test_combos <- data.frame(expand.grid(thresh_tests = thresh_tests, samp_n_tests = samp_n_tests))
```

The actual values of theta for the 50k sample we took from the mixture distribution:  

```{r}
thetas %>% 
  knitr::kable()
```


# Figure 2
First let's see the true thetas, which because of small numbers we are visualizing in log scale for the second panel: 

```{r fig.width=6, fig.height=2}
thetas %>% 
  ggplot(., aes(x = thresh_tests, y = theta)) +
  geom_point(size = 4, shape = 18, color = theta_color) +
  labs(x = "Long-distance level", y = "Theta") +
  theme_bw() -> a

thetas %>% 
  ggplot(., aes(x = thresh_tests, y = theta)) +
  geom_point(size = 4, shape = 18, color = theta_color) +
  labs(x = "Long-distance level", y = "Theta", Title = "Log Scale") +
  theme_bw() +
  scale_y_log10() -> b

plot_grid(a, b, ncol = 2)

```


Now, we explore how the estimates compare. These are already in log scale because they are small:


```{r fig.width=6, fig.height=4}
nreps_mles_df %>% 
  ggplot(., aes(x = thresh_tests, y = log_St_hat)) +
  # facet_wrap(~samp_n_tests, nrow = 1) +
  geom_point(alpha = 0.8, size = 3, color = "grey27") +
  labs(x = "Long-distance level", y = "Estimated thetas", title = "Simple Lomax") +
  scale_x_continuous(breaks = thresh_tests) +
  theme_bw() -> a

nreps_mles_df %>% 
  ggplot(., aes(x = thresh_tests, y = log_St_hat2)) +
  # facet_wrap(~samp_n_tests, nrow = 1) +
  geom_point(alpha = 0.8, size = 3, color = "grey27") +
  labs(x = "Long-distance level", y = "Estimated thetas", title = "GLM Lomax") +
  scale_x_continuous(breaks = thresh_tests) +
  theme_bw() -> b

plot_grid(a, b, nrow = 2)

```


Since there are so many points, we can see them a little more scattered with jitter:

```{r fig.width=6, fig.height=4}
nreps_mles_df %>% 
  ggplot(., aes(x = thresh_tests, y = log_St_hat)) +
  # facet_wrap(~samp_n_tests, nrow = 1) +
  geom_jitter(alpha = 0.8, size = 3, color = "grey27") +
  labs(x = "Long-distance level", y = "Estimated thetas", title = "Simple Lomax") +
  scale_x_continuous(breaks = thresh_tests) +
  theme_bw() -> a

nreps_mles_df %>% 
  ggplot(., aes(x = thresh_tests, y = log_St_hat2)) +
  # facet_wrap(~samp_n_tests, nrow = 1) +
  geom_jitter(alpha = 0.8, size = 3, color = "grey27") +
  labs(x = "Long-distance level", y = "Estimated thetas", title = "GLM Lomax") +
  scale_x_continuous(breaks = thresh_tests) +
  theme_bw() -> b

plot_grid(a, b, nrow = 2)
```

But we are seeing aggregated data, and we tested at different sample sizes:


```{r fig.width=8, fig.height=4}
nreps_mles_df %>% 
  ggplot(., aes(x = thresh_tests, y = log_St_hat)) +
  # facet_wrap(~samp_n_tests, nrow = 1) +
  geom_jitter(alpha = 0.8, size = 3, aes(color = factor(samp_n_tests))) +
  scale_color_manual(values = pal_sampsize) +
  labs(x = "Long-distance level", y = "Estimated thetas", title = "Simple Lomax") +
  scale_x_continuous(breaks = thresh_tests) +
  theme_bw() +
  theme(legend.position = "none") -> a

nreps_mles_df %>% 
  ggplot(., aes(x = thresh_tests, y = log_St_hat2)) +
  # facet_wrap(~samp_n_tests, nrow = 1) +
  geom_jitter(alpha = 0.8, size = 3, aes(color = factor(samp_n_tests))) +
  scale_color_manual(values = pal_sampsize) +
  labs(x = "Long-distance level", y = "Estimated thetas", title = "GLM Lomax") +
  scale_x_continuous(breaks = thresh_tests) +
  theme_bw() +
  theme(legend.position = "right") + 
  guides(color = guide_legend(title = "Sample Size")) -> b

ableg <- get_legend(b)

abplot <- plot_grid(a, b + theme(legend.position = "none"), nrow = 2)

plot_grid(abplot, ableg, ncol = 2, rel_widths = c(1, 0.3))

```



Can I see this as boxplots or something else? To see the differences in sample size more clearly.

```{r fig.width=8, fig.height=4}
nreps_mles_df %>% 
  mutate(samp_n_tests = factor(samp_n_tests),
         thresh_tests = factor(thresh_tests)) %>% 
  ggplot(., aes(x = thresh_tests, y = log_St_hat, fill = samp_n_tests, color = samp_n_tests)) +
  # facet_wrap(~samp_n_tests, nrow = 1) +
  geom_boxplot(alpha = 0.9) +
  scale_fill_manual(values = pal_sampsize) +
  scale_color_manual(values = pal_sampsize) +
  labs(x = "Long-distance level", y = "Theta hat", title = "Simple Lomax") +
  theme_bw() +
  theme(legend.position = "none") -> a

nreps_mles_df %>% 
  mutate(samp_n_tests = factor(samp_n_tests),
         thresh_tests = factor(thresh_tests)) %>% 
  ggplot(., aes(x = thresh_tests, y = log_St_hat2, fill = samp_n_tests, color = samp_n_tests)) +
  # facet_wrap(~samp_n_tests, nrow = 1) +
  geom_boxplot(alpha = 0.9) +
  scale_fill_manual(values = pal_sampsize, name = "Sample Size") +
  scale_color_manual(values = pal_sampsize, name = "Sample Size") +
  labs(x = "Long-distance level", y = "Theta hat", title = "GLM Lomax") +
  theme_bw() +
  theme(legend.position = "right") -> b

ableg <- get_legend(b)

abplot <- plot_grid(a, b + theme(legend.position = "none"), nrow = 2)

plot_grid(abplot, ableg, ncol = 2, rel_widths = c(1, 0.3))

```

# Figure 3
Introduce the numerical estimation thing with the simple lomax: 

```{r}
nreps_mles_df %>% 
  ggplot()+
  geom_point(aes(x = alpha_star, y = k_star, color = "Simple Lomax"), size = 4, alpha = 0.5) +
  geom_point(aes(x = alpha_glm, y = k_glm, color = "Lomax GLM"), size = 4, alpha = 0.5) +
  scale_y_log10() +
  scale_x_log10() +
  scale_color_manual(values = c("grey20", "dodgerblue4"), name = "") +
  labs(x = "Log(alpha)", y = "Log(k)", title = "Lomax Parameter Space") +
  theme_bw() +
  theme(legend.position = "bottom")


```











