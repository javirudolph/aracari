---
title: "Implications of animal movement rate variation in spatial patterns of seed dispersal"
author: "Javiera Rudolph"
date: "8/12/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(cowplot)
```


Let's say there is a variation in animal movement rates, and it depends on multiple factors, such as size of the animal, breeding status, nesting, etc. So, it can also be seasonal. Since movement rates can't really be negative, we will use a lognormal distribution to describe this variation in movement rates. 

Let $X_i$ be a positive random variable that is log-normally distributed $(i.e. X_i \sim Lognormal(\mu_i, \sigma_i^2)$ describing the distribution of movement rates for an animal population $i$. Such animal population's average movement rate being $\mu_i$ and the variance of their movement rates $\sigma_i^2$. We can assume we have three different populations, where perhaps some of them have larger home ranges, creating more variance across movement rates. To make things a little easier, we will consider all populations have the same average movement rate $(i.e. \mu_1=\mu_1=\mu_3 = 1)$, but different standard deviation $(\sigma_1=0.3, \sigma_2=0.5, \sigma_3=0.5)$. We can visualize the distribution of movement rates for each of these populations:

```{r}

av.mov.rate <- 2
max.x <- 20

mycols <- c("black", "blue", "purple")
#create density plots
curve(dlnorm(x, meanlog=av.mov.rate, sdlog=.3),
      from=0, to=max.x,
      col=mycols[1],
      main = 'Log Normally distributed movement rates for three populations', #add title
      ylab = 'Density', #change y-axis label
      )

curve(dlnorm(x, meanlog=av.mov.rate, sdlog=.5), 
      from=0, to=max.x,
      col=mycols[2], add=TRUE)

curve(dlnorm(x, meanlog=av.mov.rate, sdlog=1), 
      from=0, to=max.x,
      col=mycols[3], add=TRUE)

#add legend
legend("topright", legend=c("sdlog=.3", "sdlog=.5", "sdlog=1"),
       col=mycols, lty=1, cex=1.2)
```


Now, lets sample a movement rate, $m$, for 5 individuals $(i.e. j = 1, ...,5)$ from the first population $(i.e. m_{1,j} = m_{1,1}, ....., m_{1,5})$. We will simulate animal movement with a simple random walk, with movement length $l$ sampled from an exponential distribution, $l \sim exp(m_{i,j})$, movement angle, $\theta$, from a uniform distribution, $\theta \sim U(0, 360)$. We can visualize the movement for one of the individuals in the first population:

```{r}
n.individuals <- 5
m_1 <- sort(round(rlnorm(n.individuals, meanlog = av.mov.rate, sdlog = 0.3),3))
m_2 <- sort(round(rlnorm(n.individuals, meanlog = av.mov.rate, sdlog = 0.5),3))
m_3 <- sort(round(rlnorm(n.individuals, meanlog = av.mov.rate, sdlog = 1),3))
```

We can look at how those exponential distributions look for each of the individuals in those populations.

```{r}

mycols <- rainbow(5, s=0.8)

range <- c(-0.1,max.x+5)
#create density plots
curve(dexp(x, 1/m_1[1]), #notice rate for exponential is 1/movement rate.
      from=range[1], to=range[2], 
      col=mycols[1],
      main = 'Exponentially distributed movement lengths for 5 individuals', #add title
      ylab = 'Density', #change y-axis label
      )
for(i in 2:5){
  curve(dexp(x, 1/m_1[i]), 
        from=range[1], to=range[2],
        col=mycols[i], add=TRUE)
}

#add legend
legend("topright", legend= m_1,
       col=mycols, lty=1, cex=1.2)
```



```{r eval=FALSE}
t <- 100 # Number of time steps
individual <- 5

tru.rate <- m_1[individual] # In case I want to do scale 1/rate
movedist <- rexp(t, rate = 1/tru.rate)
angle <- runif(t, min = 0, max = 360)
distx <- movedist*cos(angle)
xloc <- c(0, cumsum(distx))
disty <- movedist*sin(angle)
yloc <- c(0, cumsum(disty))
animalTraj <- data.frame(time = 0:t, xloc = xloc, yloc = yloc)

plot(x = xloc, y = yloc, col = mycols[individual], type = "l", main = paste("Rate", tru.rate))

```

```{r}
sim_movement <- function(prm, t = 1000, plot.it = TRUE, return.data.frame = FALSE){
  tru.rate <- round(prm, 3)
  movedist <- rexp(t, rate = 1/tru.rate)
  angle <- runif(t, min = 0, max = 360)
  distx <- movedist*cos(angle)
  xloc <- c(0, cumsum(distx))
  disty <- movedist*sin(angle)
  yloc <- c(0, cumsum(disty))
  animalTraj <- data.frame(time = 0:t, xloc = xloc, yloc = yloc)
  if(plot.it == TRUE){
    plot(x = xloc, y = yloc, type = "l", main = paste("Rate=",tru.rate))
  }
  if(return.data.frame == TRUE){
    return(animalTraj)
  }
}
```

```{r eval=FALSE}
par(mfrow=c(2,5))

for(j in 1:individual){
  sim_movement(m_1[j])}

```

Use ggplot to make multiple rounds of each individual
```{r eval=FALSE}

df <- sim_movement(m_1[1], plot.it = FALSE, return.data.frame = TRUE)

df %>% 
  ggplot(., aes(x = xloc, y=yloc)) +
  geom_path()

```

## Movement for individuals in the three populations
```{r eval=FALSE}
nruns <- 3
# Population1
df <- NULL

for(j in 1:n.individuals){
  for(k in 1:nruns){
  a <- sim_movement(m_1[j], plot.it = FALSE, return.data.frame = TRUE) %>% 
    mutate(indiv = as.factor(j),
           run = paste("r_", k))
  df <- rbind.data.frame(df, a)
}
}
  

df %>% 
  ggplot(., aes(x = xloc, y=yloc, group = run, color = indiv)) +
  geom_path() +
  scale_color_manual(values = mycols) +
  theme_bw()

# Population2
df <- NULL

for(j in 1:n.individuals){
  for(k in 1:nruns){
  a <- sim_movement(m_2[j], plot.it = FALSE, return.data.frame = TRUE) %>% 
    mutate(indiv = as.factor(j),
           run = paste("r_", k))
  df <- rbind.data.frame(df, a)
}
}
  

df %>% 
  ggplot(., aes(x = xloc, y=yloc, group = run, color = indiv)) +
  geom_path() +
  scale_color_manual(values = mycols) +
  theme_bw()

# Population3
df <- NULL

for(j in 1:n.individuals){
  for(k in 1:nruns){
  a <- sim_movement(m_3[j], plot.it = FALSE, return.data.frame = TRUE) %>% 
    mutate(indiv = as.factor(j),
           run = paste("r_", k))
  df <- rbind.data.frame(df, a)
}
}
  

df %>% 
  ggplot(., aes(x = xloc, y=yloc, group = run, color = indiv)) +
  geom_path() +
  scale_color_manual(values = mycols) +
  theme_bw()
```


```{r}
nruns <- 3
m.data <- data.frame(m_1, m_2, m_3)

df <- NULL

for(m in 1:3){
  m.0 <- m.data[m]
  for(j in 1:n.individuals){
  for(k in 1:nruns){
  a <- sim_movement(m_2[j], plot.it = FALSE, return.data.frame = TRUE) %>% 
    mutate(indiv = as.factor(j),
           run = paste0("r_", k),
           pop.id = paste0("p_",m))
  df <- rbind.data.frame(df, a)
}
}
  
}


df %>% 
  ggplot(., aes(x = xloc, y=yloc, group = run, color = indiv)) +
  facet_wrap(~pop.id) +
  geom_path() +
  scale_color_manual(values = mycols) +
  theme_bw() +
  theme(legend.position = "bottom") +
  NULL
```



Now, we get the animals to disperse seeds. Seeds gut retention time are sampled from a gamma distribution.
```{r eval=FALSE}
nseeds <- 20
grt <- round(rgamma(nseeds, shape = 4, scale = 5))
t.grt <- max(grt)

animalTraj <- sim_movement(m_1[1], t = t.grt, plot.it = FALSE, return.data.frame = TRUE)

animalTraj %>% 
  left_join(., data.frame(s.id = 1:nseeds, time = grt)) %>% 
  mutate(disp = sqrt(xloc^2+yloc^2)) -> df

df %>% 
  drop_na(s.id) %>% 
  mutate(xi = (mean(xloc)-xloc)^2,
         yi = (mean(yloc)-yloc)^2) %>% 
  summarise(x = mean(xloc),
            y = mean(yloc),
            av.disp = mean(disp),
            se.disp = sd(disp)/sqrt(n()),
            dsprsn = sum(sqrt(xi+yi))/n()) -> s.df


# Calculate the mean location of seeds
x_m <- mean(seed_loc$xloc)
y_m <- mean(seed_loc$yloc)
mean_dispersal <- mean(seed_loc$dispersal)
se_dispersal <- sd(seed_loc$dispersal)/sqrt(length(seed_loc$dispersal))

# Calculate seed dispersion
xi <- (x_m - seed_loc$xloc)^2
yi <- (y_m - seed_loc$yloc)^2
seed_dispersion <- sum(sqrt(xi + yi))/length(seed_loc$time)

df %>% 
  ggplot(., aes(x = xloc, y=yloc)) +
  geom_path() +
  geom_point(data = df %>% drop_na(s.id), 
             aes(x = xloc, y = yloc)) +
  geom_point(data = s.df,
             aes(x = x, y = y), color = "Red") # Mean location of seeds

```



```{r}
sim_seeds <- function(nseeds = 20, m.prms = NULL,...){
  grt <- round(rgamma(nseeds, shape = 4, scale = 5))
  t.grt <- max(grt)

  df <- sim_movement(m.prms, t = t.grt, plot.it = FALSE, return.data.frame = TRUE)

  df %>% 
    left_join(., data.frame(s.id = 1:nseeds, time = grt)) %>% 
    mutate(disp = sqrt(xloc^2+yloc^2)) -> df
  
  return(df)
}

summ_seeds <- function(df = NULL){
  df %>% 
  drop_na(s.id) %>% 
  mutate(xi = (mean(xloc)-xloc)^2,
         yi = (mean(yloc)-yloc)^2) %>% 
  summarise(x = mean(xloc),
            y = mean(yloc),
            av.disp = mean(disp),
            se.disp = sd(disp)/sqrt(n()),
            dsprsn = sum(sqrt(xi+yi))/n()) -> s.df
  return(s.df)
}

# a <- sim_seeds(m.prms = m_1[1])
# summ_seeds(a)
```

Run a simulation for one individual, multiple runs, display animal movement, seed dispersal and print summary for all runs
```{r message=FALSE}
nruns <- 100

df <- NULL
summ.df <- NULL

for(j in 1:1){
  for(k in 1:nruns){
    a <- sim_seeds(m.prms = m_1[j]) %>% 
      mutate(indiv = as.factor(j),
             run = factor(paste0("r_", k), levels = paste0("r_", 1:nruns)))
    
    b <- summ_seeds(a) %>% 
      mutate(indiv = as.factor(j),
             run = factor(paste0("r_", k), levels = paste0("r_", 1:nruns)))
    
    df <- rbind.data.frame(df, a) 
    summ.df <- rbind.data.frame(summ.df, b) 
}
}
```

```{r}

df %>% 
  ggplot(., aes(x = xloc, y=yloc, 
                group = run,
                color = indiv)) +
  # facet_wrap(~run) +
  geom_path() +
  scale_color_manual(values = mycols) +
  geom_point(data = df %>% drop_na(s.id), 
             aes(x = xloc, y = yloc)) +
  geom_point(data = summ.df, aes(x = x, y=y), color = "black") +
  theme_bw() +
  labs(title = "Animal seed droppings", caption = "Lines show an individual's trajectory.\n Red dots show all seed droppings.\n Black dots show average location of seed per run") +
  theme(legend.position = "none") -> p1
# p1

df %>% 
  ggplot(., aes(x = xloc, y = yloc)) +
  # stat_density_2d(aes(fill = ..level..), geom = "polygon", colour="white") +
  geom_bin2d() +
  # geom_hex() +
  # scale_fill_continuous(type = "viridis") +
  scale_fill_gradient(low = "grey", high = "black") +
  theme_bw() +
  theme(legend.position = "bottom") +
  labs(title = "Density of animal movement") -> p2
p2

cowplot::plot_grid(p1, p2)
  
# summ.df %>% 
#   ggplot(., aes(y = dsprsn)) +
#   geom_boxplot()
# 
# summ.df %>% 
#   ggplot(., aes(x = av.disp)) +
#   geom_density(color = "blue") + # for the average dispersal per run
#   geom_density(data = df %>% drop_na(s.id),
#                  aes(x = disp)) + # for every seed
#   theme_bw()
```

Next steps.
Fit a weibull distribution to the raw seed dispersal data, probably subsample.
Provide summary stats for the dispersal and dispersion measures.

```{r}
# s.df <- df %>% drop_na(s.id)

s.df <- df %>% drop_na(s.id) %>% 
  sample_n(., 50)
  
library(fitdistrplus)

g <- fitdist(s.df$disp, distr = "weibull")
summary(g)
plot(g)

# library(MASS)
# fitdistr(s.df$disp, densfun = "weibull")
```

# Simulation for population 1
```{r message=FALSE}
nruns <- 20

df <- NULL
summ.df <- NULL

for(j in 1:n.individuals){
  for(k in 1:nruns){
    a <- sim_seeds(m.prms = m_1[j]) %>% 
      mutate(indiv = as.factor(j),
             run = factor(paste0("r_", k), levels = paste0("r_", 1:nruns)))
    
    b <- summ_seeds(a) %>% 
      mutate(indiv = as.factor(j),
             run = factor(paste0("r_", k), levels = paste0("r_", 1:nruns)))
    
    df <- rbind.data.frame(df, a) 
    summ.df <- rbind.data.frame(summ.df, b) 
}
}
```

Visualize animal movement and seed dispersal. It is kind of obvious, but individuals that move further away, also disperse seeds further away and scatter them more. Red points are every seed dispersed, black points show the average seed location per run. Each panel corresponds to one individual disperser.
```{r}
df %>% 
  ggplot(., aes(x = xloc, y = yloc)) +
  facet_wrap(~indiv) +
  # stat_density_2d(aes(fill = ..level..), geom = "polygon", colour="white") +
  geom_bin2d() +
  # geom_hex() +
  # scale_fill_continuous(type = "viridis") +
  scale_fill_gradient(low = "grey", high = "black") +
  geom_point(data = df %>% drop_na(s.id),
             aes(x = xloc, y = yloc), color = "red", alpha = 0.3) +
  geom_point(data = summ.df, aes(x = x, y=y), color = "black") +
  theme_bw()
```

Seed dispersal kernels produced by each individual.
```{r}
df %>% 
  drop_na(s.id) %>% 
  ggplot(., aes(x = disp, color = indiv)) +
  geom_density() +
  scale_color_manual(values = mycols) +
  theme_bw()

```

Dispersion. We calculate dispersion for every simulated run. Every run means an individual disperser gets 20 seeds, they move until they drop all seeds. Then, dispersion measures how far away from each other every seed is. 
```{r}
summ.df %>% 
  ggplot(., aes(y = dsprsn, x = indiv)) + 
  geom_boxplot()
```
```{r}
s.df <- df %>% drop_na(s.id) %>%
  group_by(indiv) %>%
  sample_n(., 50)

# s.df <- df %>% drop_na(s.id)

weib.fits <- NULL

for(i in 1:individual){
  dat <- s.df %>% 
    filter(indiv == i)
  #g <- fitdist(dat$disp, distr = "weibull", method = 'mle', lower = c(0,0))
  g <- fitdistr(dat$disp, densfun = "weibull", lower = c(0,0))
  prms.weib <- data.frame(est.shape = as.numeric(g$estimate[1]),
                          est.scale = as.numeric(g$estimate[2]),
                          loglik = g$loglik, indiv = i)
  weib.fits <- rbind.data.frame(weib.fits, prms.weib)
  # plot(g)
}

weib.fits
```
Bootstrapping?
```{r}
weib.boot <- NULL

for(j in 1:10){
      s.df <- df %>% drop_na(s.id) %>%
      group_by(indiv) %>%
      sample_n(., 50)
    
    # s.df <- df %>% drop_na(s.id)
    
    weib.fits <- NULL
    
    for(i in 1:individual){
      dat <- s.df %>% 
        filter(indiv == i)
      #g <- fitdist(dat$disp, distr = "weibull", method = 'mle', lower = c(0,0))
      g <- fitdistr(dat$disp, densfun = "weibull", lower = c(0,0))
      prms.weib <- data.frame(est.shape = as.numeric(g$estimate[1]),
                              est.scale = as.numeric(g$estimate[2]),
                              loglik = g$loglik, indiv = i)
      weib.fits <- rbind.data.frame(weib.fits, prms.weib)
      # plot(g)
    }
    
    weib.boot <- rbind.data.frame(weib.boot, weib.fits %>% mutate(boot = j))
}

weib.boot
```

```{r}
library(Hmisc)

weib.boot %>% 
  ggplot(., aes(x = factor(indiv), y = est.scale)) +
  geom_violin() +
  #geom_boxplot(width = 0.1) +
  stat_summary(fun.data=mean_sdl, mult=1, 
                 geom="pointrange", color="red") +
  theme_bw()

```
