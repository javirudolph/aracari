---
title: "Implications of animal movement rate variation in spatial patterns of seed dispersal"
author: "Javiera Rudolph"
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
# knitr::opts_chunk$set(fig.width=12, fig.height=6)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r message=FALSE, warning=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(cowplot)
library(fitdistrplus)
library(Hmisc)
library(gtsummary)
```


```{r include=FALSE}
set.seed(98)

# Source functions -----------------------------------------------------------------

source("Ch1_movement_rates/Ch1_functions.R")

# LOAD the data ------------------------------------------------------------------------

load(file = "Ch1_movement_rates/ptpl.RData")

null_moverate <- data.frame(Bird_ID = unique(ptpl$Bird_ID), movrate = mean(ptpl$mpm))

indiv_moverate <- ptpl %>%
  group_by(Bird_ID, fam_g) %>%
  summarise(movrate = mean(mpm))

fam_moverate <- ptpl %>%
  group_by(fam_g) %>%
  summarise(movrate = mean(mpm),
            sd = sd(mpm))

ids <- ptpl %>% distinct(., Bird_ID, fam_g)

# Average movement rate for this 'population'
# mean(indiv_moverate$movrate)
# mean(ptpl$mpm)

# Color palette ----------------------------------------
my.cols1 <- c("#23262f","#717492","#b3a82a","#c94f21","#980012","#0d907a","#b9bec3")

# Fit a lognormal to the distribution of movement rates

logfit <- fitdist(indiv_moverate$movrate, distr = 'lnorm')
movrate_cp_ln <- as.numeric(exp(logfit$estimate[1]))

```

# Figure 1  

```{r}
# Figure 1 - example of how the process works.
# set.seed(72)
# set.seed(987)
set.seed(235)

cols.fig1 <- c("#23262f","#717492","#b3a82a","#c94f21","#980012","#0d907a","#b9bec3")
#library(scales)
#show_col(cols.fig1)

# We are using 5 seeds
nseeds <- 5

# Doing one run for the first three panels.

test_run <- sim_seeds(nseeds = nseeds, m.prms = movrate_cp_ln)
#test_run

# Calculate summary for seeds in this run
summ_test_run <- summ_seeds(test_run)
# Visualize this one run:
test_run %>%
  ggplot(., aes(x = xloc, y = yloc)) +
  geom_path(color = cols.fig1[2]) +
  geom_point(aes(x=0, y=0), color = cols.fig1[6], size = 4) +
  geom_point(data = test_run %>% drop_na(s.id),
             aes(x = xloc, y = yloc), shape = "diamond", size = 2.5) +
  # geom_point(data = summ_test_run,
  #            aes(x = x, y = y), color = "#59879A") +
  labs(x = "x", 
       #title = "Example of one simulation run",
       y = "y") +
  theme_bw() -> A

test_run %>%
  ggplot(., aes(x = xloc, y = yloc)) +
  geom_path(color = "white", alpha = 0.1) +
  geom_segment(data = test_run %>% drop_na(s.id),
               aes(x = xloc, y = yloc, xend = summ_test_run$x, yend = summ_test_run$y), lty = 2, color = cols.fig1[4]) +
  geom_point(data = test_run %>% drop_na(s.id),
             aes(x = xloc, y = yloc), shape = "diamond", size = 2.5) +
  geom_point(aes(x=0, y=0), color = cols.fig1[6], size = 4) +
  geom_point(data = summ_test_run,
             aes(x = x, y = y), color = cols.fig1[4], size = 4, shape = "square") +
  labs(x = "x", 
       #title = "Average dispersal and dispersion per run",
       y = "y") +
  theme_bw() -> B

test_run %>%
  ggplot(., aes(x = xloc, y = yloc)) +
  geom_path(color = "white", alpha = 0.1) +
  geom_segment(aes(x = summ_test_run$x, xend = 0, y = summ_test_run$y, yend = 0), color = cols.fig1[1], lty = "twodash") +
  geom_segment(data = test_run %>% drop_na(s.id),
               aes(x = xloc, y = yloc, xend = 0, yend = 0), lty = 2, color = cols.fig1[6]) +
  #geom_segment(aes(x = summ_test_run$x, xend = 0, y = summ_test_run$y, yend = 0), color = "#87A986", lty = 2) +
  geom_point(data = test_run %>% drop_na(s.id),
             aes(x = xloc, y = yloc), shape = "diamond", size = 2.5) +
  geom_point(data = summ_test_run,
             aes(x = x, y = y), color = cols.fig1[4], size = 4, shape = "square") +
  geom_point(aes(x=0, y=0), color = cols.fig1[6], size = 4) +
  labs(x = "x",
       #title = "Seed dispersal distance from parent tree",
       y = "y") +
  theme_bw() -> C

# The fourth panel will show the histogram and weibull fit for the seed dispersal kernel generated from 100 simulation runs
kruns <- 100
test.df <- NULL
test.summ.df <- NULL

for(k in 1:kruns){
  a <- sim_seeds(m.prms = movrate_cp_ln, nseeds = nseeds) %>%
    mutate(run = factor(paste0("r_", k), levels = paste0("r_", 1:kruns)),
           model = "test")

  b <- summ_seeds(a) %>%
    mutate(run = factor(paste0("r_", k), levels = paste0("r_", 1:kruns)),
           model = "test")

  test.df <- rbind.data.frame(test.df, a)
  test.summ.df <- rbind.data.frame(test.summ.df, b)
}

test.df %>% drop_na(s.id) -> seed.df

weib.fit <- fitdistr(seed.df$disp, densfun = "weibull")


test.df %>%
  drop_na(s.id) %>%
  ggplot(., aes(x = disp)) +
  geom_histogram(aes(y = ..density..), bins = 30, fill = cols.fig1[7], color = cols.fig1[6]) +
  stat_function(fun = dweibull, args = list(shape = weib.fit$estimate[1], scale = weib.fit$estimate[2]),
                color = "black", alpha = 0.8, size = 1) +
  labs(x = "Distance in meters", 
       #title = "SDK from 100 runs",
       y = "Density") +
  theme_bw() -> D


plot_grid(A, B, C, D, labels = "AUTO")

# ggsave2(filename = "Ch1_movement_rates/Figures/Figure1.png")
```


**Figure1** - Simulation process overview and seed dispersal measures.  Panels A through C represent one simulation run, whereas panel D shows the results from 100 simulation runs. A) An animal starts at the origin (coordinates (0,0) represented by the teal dot) where it ingests five seeds. The animal moves in the landscape (grey trajectory path) and drops seeds (black diamonds) as it reaches their gut retention time. B) The mean seed location per run is calculated and shown in the orange square. The distance of each seed to the mean location is used to calculate seed dispersion as described in the main text. C) Average seed dispersal per run (black dashed line) is calculated as the distance from the origin (teal dot) to the mean seed location (orange square). Seed dispersal distance for each seed (teal dashed lines) are calculated as the distance of each seed from the origin. D) Seed dispersal distances for each seed in 100 simulation runs are used to generate a seed dispersal distance histogram. A Weibull distribution is fit to the data to describe the seed dispersal kernel.

# Table 1  

```{r}
ptpl %>% 
  group_by(Bird_ID, fam_g) %>% 
  summarise(movrate = round(mean(mpm),1),
            obs = n()) %>% 
  left_join(., ptpl %>% 
              group_by(fam_g) %>% 
              summarise(famrate = round(mean(mpm), 1))) %>% 
  dplyr::select(Bird_ID, obs, movrate, fam_g, famrate) -> table1

knitr::kable(table1)
# write.csv(table1, file = "Ch1_movement_rates/Figures/table1.csv")

```


# Figure 2   

```{r}
# Visualize distribution and data points

load("Ch1_movement_rates/sims_backup/movrates.RData")

cols.fig2 <- c("#23262f","#717492","#b3a82a","#c94f21","#980012","#0d907a","#b9bec3")

# Movement rates used for each scenario

# movrate_cp
# movrate_np
# movrate_pp

movratedf <- data.frame(scenario = "cp", group = NA, movrate = movrate_cp) %>% 
  bind_rows(., data.frame(scenario = rep("pp", 42), group = movrate_pp$fam_g, movrate = movrate_pp$movrate)) %>% 
  bind_rows(., data.frame(scenario = rep("np", 30), group = NA, movrate = movrate_np))

# Logfit plot

indiv_moverate %>%
  ggplot(., aes(x = movrate, y = 0.002, color = fam_g)) +
  geom_point(size = 3, alpha = 0.8) +
  # geom_point(data = fam_moverate, aes(x = movrate, y = 0.004),size = 3, alpha = 0.8, color = my.cols1[4]) +
  stat_function(fun = dlnorm, args = list(meanlog = logfit$estimate[1], sdlog = logfit$estimate[2]),
                color = "black", alpha = 0.8, size = 1) +
  scale_color_manual(values = cols.fig2) +
  labs(x = "Movement Rate (meters/minute)", y = "Density",
       title = "Lognormal fit to individual movement rates") +
  #geom_vline(xintercept = vlines, color = my.cols1[4], size = 1, lty = 2) +
  scale_x_continuous(limits = c(0, 70)) +
  #scale_x_discrete(labels = c(0, vlines[1], 20, vlines[2], 40, vlines[3], 60)) +
  guides(color = guide_legend(title = "Social Group",
                              ncol = 2)) +
  theme_bw() +
  theme(legend.position = "none") +
  NULL -> logfit_plot

# Estimate the mu's for each family group based on their movement rate.
logfit.sigma <- logfit$estimate[2]
get_mu <- function(movrate, sigma = logfit.sigma){
  mu <- log(movrate)-((sigma^2)/2)
  return(mu)
}

fam_mus <- get_mu(fam_moverate$movrate)

glines <- purrr::map(1:7, function(y)
    stat_function(fun = dlnorm, args = list(meanlog = fam_mus[y], sdlog = logfit.sigma), color = cols.fig2[y]))


fam_moverate %>%
  ggplot(., aes(x = movrate, y = -0.002, color = fam_g)) +
  geom_point(size = 3, alpha = 0.8) +
  glines +
  scale_color_manual(values = cols.fig2) +
  labs(x = "Movement Rate (meters/minute)", y = "Density",
       title = "Distribution for social group movement rates") +
  #geom_vline(xintercept = vlines, color = my.cols1[4], size = 1, lty = 2) +
  scale_x_continuous(limits = c(0, 70)) +
  #scale_x_discrete(labels = c(0, vlines[1], 20, vlines[2], 40, vlines[3], 60)) +
  guides(color = guide_legend(title = "Social Group",
                              ncol = 2)) +
  theme_bw() +
  theme(legend.position = c(0.8, 0.6)) -> social_group_curves

movratedf %>% 
  ggplot(., aes(x = movrate, y = factor(scenario, levels = c("pp", "np", "cp")), color = as.character(group))) +
  geom_jitter(size = 3, alpha = 0.8, height = 0.1) +
  scale_color_manual(values = cols.fig2) +
  scale_x_continuous(limits = c(0, 70)) +
  labs(x = "Movement Rate (meters/minute)", y = "Model scenario",
       title = "Sampled movement rates for each simulated scenario") +
  #scale_x_discrete(labels = c(0, vlines[1], 20, vlines[2], 40, vlines[3], 60)) +
  guides(color = guide_legend(title = "Social Group",
                              ncol = 2)) +
  theme_bw() +
  theme(legend.position = "none") +
  NULL-> movrates_used

```

```{r fig.height=12, fig.width=6}
plot_grid(logfit_plot, social_group_curves, movrates_used, nrow = 3, rel_heights = c(2,2,1))


ggsave2(filename = "Ch1_movement_rates/Figures/Figure2.png")

```




# Figure 3 - gut retention times:  


```{r include=FALSE}
load("data/grt_data.rda") 


grt_fit <- fitdist(grt_data$grt, "gamma")
plot(grt_fit)

```

```{r}

grt_data %>% 
  ggplot() +
  geom_histogram(aes(x = grt, y = ..density..), fill = my.cols1[7], bins = 20) +
  stat_function(fun = dgamma, args = list(shape = grt_fit$estimate[1], rate = grt_fit$estimate[2])) +
  #stat_function(fun = dgamma, args = list(shape = 4, scale = 5), color = "red") + 
  geom_point(aes(x = grt, color = Bird_ID, y = 0), size = 4) +
  scale_color_manual(values = c(my.cols1[4], my.cols1[2], my.cols1[3], my.cols1[1])) +
  theme_bw() +
  labs(x = "Gut retention time in minutes", y = "Density") +
  theme(legend.position = "none")+
  NULL

# ggsave2(filename = "Ch1_movement_rates/Figures/Figure3.png")

```


 



```{r}
# Bring data --------------------------------------------
load("Ch1_movement_rates/sims_backup/datagen_cp.RData")
load("Ch1_movement_rates/sims_backup/datagen_pp.RData")
load("Ch1_movement_rates/sims_backup/datagen_np.RData")

load("Ch1_movement_rates/sims_backup/weib_cp.RData")
load("Ch1_movement_rates/sims_backup/weib_pp.RData")
load("Ch1_movement_rates/sims_backup/weib_np.RData")


```

```{r}
# Dispersion and Dispersal --------------------------------------------------------------------

cp.summ.df %>%
  dplyr::select(av.disp, dsprsn, model) %>% 
  bind_rows(., pp.summ.df %>%
              dplyr::select(av.disp, dsprsn, model)) %>%
  bind_rows(., np.summ.df %>%
              dplyr::select(av.disp, dsprsn,  model)) %>% 
  mutate(model = factor(model, levels = c("cp", "pp","np"))) -> disp_df
```


# Figure 4 - average dispersal and dispersion per run  

Importance of the outliers here

```{r}
disp_df %>%
  group_by(., model) %>%
  sample_n(., 5000) %>%
  ggplot(., aes(y = dsprsn, x = model)) +
  geom_boxplot() +
  #geom_point(color = "grey", alpha = 0.5) +
  labs(title = "Dispersion", y = "Dispersion in meters", x = "Model") +
  theme_bw() +
  theme(legend.position = "none") -> p_dispersion

disp_df %>%
  group_by(., model) %>%
  sample_n(., 5000) %>%
  ggplot(., aes(y = av.disp, x = model)) +
  geom_boxplot() +
  #geom_point(color = "grey", alpha = 0.5) +
  labs(title = "Average dispersal", y = "Dispersal in meters", x = "Model") +
  theme_bw() +
  theme(legend.position = "none") -> p_dispersal

plot_grid(p_dispersal, p_dispersion)

# ggsave2(filename = "Ch1_movement_rates/Figures/Figure4.png")

```


# Figure x - seed dispersal kernel parameters
Here we are using the distance of each seed

```{r}

# Weibull fit ------------------------------------------------------------

weib.boot.cp %>%
  dplyr::select(., est.shape, est.scale, boot, model) %>%
  bind_rows(., weib.boot.pp %>%
              dplyr::select(., est.shape, est.scale, boot, model)) %>%
  bind_rows(., weib.boot.np %>%
              dplyr::select(., est.shape, est.scale, boot, model)) -> joint_weib

joint_weib %>% 
  mutate(model = factor(model, levels = c("cp", "pp",
                                          "np"))) -> joint_weib

```

## Variation 1 - violin plot with 200 out of 1000 of the parameter fits

```{r}
joint_weib %>%
  group_by(model) %>%
  sample_n(., 200) %>%
  ggplot(., aes(x = model, y = est.shape)) +
  geom_violin() +
  # scale_color_manual(values = c("black", mycols)) +
  # geom_boxplot(width = 0.01) +
  # geom_point(color = "grey", alpha = 0.5) +
  # stat_summary(fun.data=mean_sdl, mult=1,
  #              geom="pointrange", color="black") +
  geom_jitter(position = position_jitter(0.1)) +
  geom_hline(aes(yintercept = 1), lty = "dashed") +
  labs(title = "Shape") +
  #scale_y_continuous(limits = c(0, 2)) +
  theme_bw() -> weib_shape

joint_weib %>%
  group_by(model) %>%
  sample_n(., 200) %>%
  ggplot(., aes(x = model, y = est.scale)) +
  geom_violin() +
  # scale_color_manual(values = c("black", mycols)) +
  # geom_boxplot(width = 0.01) +
  # geom_point(color = "grey", alpha = 0.5) +
  # stat_summary(fun.data=mean_sdl, mult=1,
  #              geom="pointrange", color="black") +
  geom_jitter(position = position_jitter(0.1)) +
  labs(title = "Scale") +
  theme_bw() -> weib_scale

plot_grid(weib_shape, weib_scale)

# ggsave2(filename = "Ch1_movement_rates/Figures/weib_plot.png")

```



## Variation 2 - violin plot with all 1000 of the parameter fits

```{r}
joint_weib %>%
  group_by(model) %>%
  sample_n(., 1000) %>%
  ggplot(., aes(x = model, y = est.shape)) +
  geom_violin() +
  # scale_color_manual(values = c("black", mycols)) +
  # geom_boxplot(width = 0.01) +
  # geom_point(color = "grey", alpha = 0.5) +
  # stat_summary(fun.data=mean_sdl, mult=1,
  #              geom="pointrange", color="black") +
  geom_jitter(position = position_jitter(0.1)) +
  geom_hline(aes(yintercept = 1), lty = "dashed") +
  labs(title = "Shape") +
  #scale_y_continuous(limits = c(0, 2)) +
  theme_bw() -> weib_shape

joint_weib %>%
  group_by(model) %>%
  sample_n(., 1000) %>%
  ggplot(., aes(x = model, y = est.scale)) +
  geom_violin() +
  # scale_color_manual(values = c("black", mycols)) +
  # geom_boxplot(width = 0.01) +
  # geom_point(color = "grey", alpha = 0.5) +
  # stat_summary(fun.data=mean_sdl, mult=1,
  #              geom="pointrange", color="black") +
  geom_jitter(position = position_jitter(0.1)) +
  labs(title = "Scale") +
  theme_bw() -> weib_scale

plot_grid(weib_shape, weib_scale)

# ggsave2(filename = "Ch1_movement_rates/Figures/weib_plot.png")

```

## Variation 3 - boxplot with all the fits, 1000

```{r}
joint_weib %>%
  group_by(model) %>%
  sample_n(., 1000) %>%
  ggplot(., aes(x = model, y = est.shape)) +
  geom_boxplot() +
  # geom_violin() +
  # scale_color_manual(values = c("black", mycols)) +
  # geom_boxplot(width = 0.01) +
  # geom_point(color = "grey", alpha = 0.5) +
  # stat_summary(fun.data=mean_sdl, mult=1,
  #              geom="pointrange", color="black") +
  #geom_jitter(position = position_jitter(0.1)) +
  geom_hline(aes(yintercept = 1), lty = "dashed") +
  labs(title = "Shape") +
  #scale_y_continuous(limits = c(0, 2)) +
  theme_bw() -> weib_shape

joint_weib %>%
  group_by(model) %>%
  sample_n(., 1000) %>%
  ggplot(., aes(x = model, y = est.scale)) +
  geom_boxplot() +
  #geom_violin() +
  # scale_color_manual(values = c("black", mycols)) +
  # geom_boxplot(width = 0.01) +
  # geom_point(color = "grey", alpha = 0.5) +
  # stat_summary(fun.data=mean_sdl, mult=1,
  #              geom="pointrange", color="black") +
  #geom_jitter(position = position_jitter(0.1)) +
  labs(title = "Scale") +
  theme_bw() -> weib_scale

plot_grid(weib_shape, weib_scale)

# ggsave2(filename = "Ch1_movement_rates/Figures/weib_plot.png")

```

```{r eval=FALSE}

smean.cl.normal(weib.boot.cp$est.shape) -> cp.shape
smean.cl.normal(weib.boot.cp$est.scale) -> cp.scale

smean.cl.normal(weib.boot.pp$est.shape) -> pp.shape
smean.cl.normal(weib.boot.pp$est.scale) -> pp.scale

smean.cl.normal(weib.boot.np$est.shape) -> np.shape
smean.cl.normal(weib.boot.np$est.scale) -> np.scale


cp.df %>% 
  bind_rows(pp.df, np.df) %>% 
  drop_na(., s.id) %>% 
  group_by(model) %>% 
  sample_n(5000) %>% 
  ggplot(., aes(x = disp)) +
  geom_histogram(aes(y = ..density..), fill = "lightgray") +
  stat_function(fun = dweibull, args = list(shape = cp.shape[1], scale = cp.scale[1]), color = "blue") +
  # stat_function(fun = dweibull, args = list(shape = cp.shape[2], scale = cp.scale[2]), color = "blue", lty = "dashed") +
  # stat_function(fun = dweibull, args = list(shape = cp.shape[3], scale = cp.scale[3]), color = "blue", lty = "dashed") +
  stat_function(fun = dweibull, args = list(shape = pp.shape[1], scale = pp.scale[1]), color = "black") +
  # stat_function(fun = dweibull, args = list(shape = pp.shape[2], scale = pp.scale[2]), color = "black", lty = "dashed") +
  # stat_function(fun = dweibull, args = list(shape = pp.shape[3], scale = pp.scale[3]), color = "black", lty = "dashed") +
  stat_function(fun = dweibull, args = list(shape = np.shape[1], scale = np.scale[1]), color = "red") +
  # stat_function(fun = dweibull, args = list(shape = np.shape[2], scale = np.scale[2]), color = "red", lty = "dashed") +
  # stat_function(fun = dweibull, args = list(shape = np.shape[3], scale = np.scale[3]), color = "red", lty = "dashed") +
  theme_bw() +
  # geom_vline(aes(xintercept = 500)) +
  # coord_cartesian(xlim = c(500, 1700), ylim = c(0, 0.0005)) +
  NULL

```


# Table 2 - results  
Data for each seed, not per run

```{r}
# here::here()
disp_table <- read.csv("Ch1_movement_rates/Figures/table2.csv")

knitr::kable(disp_table)

```



